<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°è‚¡åšç©ºè¨Šè™Ÿè©•åˆ†ç³»çµ±</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a3e 100%);
            color: #eee;
            min-height: 100vh;
            padding: 15px;
        }
        .container { max-width: 1600px; margin: 0 auto; }
        
        header {
            text-align: center;
            padding: 20px;
            background: rgba(255,255,255,0.03);
            border-radius: 15px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        header h1 {
            font-size: 1.8em;
            background: linear-gradient(90deg, #ff416c, #ff4b2b, #f7971e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .subtitle { color: #888; margin-top: 8px; }
        
        .recommendation-box {
            background: linear-gradient(135deg, rgba(255,65,108,0.15), rgba(255,75,43,0.15));
            border: 2px solid;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 25px;
            text-align: center;
        }
        .rec-title { font-size: 1.3em; margin-bottom: 15px; }
        .rec-action { font-size: 2.5em; font-weight: bold; margin: 15px 0; }
        .rec-detail { font-size: 1.1em; color: #ccc; line-height: 1.8; }
        .rec-wait { border-color: #666; }
        .rec-watch { border-color: #feca57; }
        .rec-prepare { border-color: #ff9f43; }
        .rec-trial { border-color: #ff6b6b; }
        .rec-build { border-color: #ee5a24; }
        .rec-add { border-color: #eb2f06; }
        .rec-heavy { border-color: #ff0000; animation: glow 1.5s infinite; }
        
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px rgba(255,0,0,0.3); }
            50% { box-shadow: 0 0 40px rgba(255,0,0,0.6); }
        }
        
        .score-display {
            display: flex;
            justify-content: center;
            gap: 40px;
            flex-wrap: wrap;
            margin: 25px 0;
        }
        .score-item {
            text-align: center;
            padding: 20px 30px;
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            min-width: 150px;
        }
        .score-value { font-size: 3em; font-weight: bold; }
        .score-label { color: #888; margin-top: 5px; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); }
        
        .card {
            background: rgba(255,255,255,0.03);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.08);
        }
        .card-title {
            font-size: 1.1em;
            color: #48dbfb;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .indicator-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            margin: 6px 0;
            background: rgba(255,255,255,0.02);
            border-radius: 8px;
            border-left: 3px solid transparent;
        }
        .indicator-item.triggered {
            background: rgba(255,107,107,0.15);
            border-left-color: #ff6b6b;
        }
        
        .ind-name { flex: 1; }
        .ind-value { min-width: 80px; text-align: right; font-family: monospace; }
        .ind-weight { min-width: 40px; text-align: center; font-size: 0.8em; color: #666; }
        .ind-status { min-width: 30px; text-align: center; font-size: 1.2em; }
        
        .price-box { text-align: center; padding: 15px; }
        .price-main { font-size: 2.2em; font-weight: bold; }
        .price-change { font-size: 1.1em; margin-top: 5px; }
        .up { color: #ff6b6b; }
        .down { color: #26de81; }
        
        .ma-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 10px; }
        .ma-item { text-align: center; padding: 10px; background: rgba(255,255,255,0.03); border-radius: 8px; }
        .ma-item .value { font-size: 1.1em; font-weight: bold; }
        .ma-item .label { font-size: 0.75em; color: #888; }
        .ma-item.above { border-bottom: 2px solid #26de81; }
        .ma-item.below { border-bottom: 2px solid #ff6b6b; }
        
        .action-table { width: 100%; margin-top: 15px; }
        .action-table th, .action-table td { padding: 12px 8px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.08); }
        .action-table th { color: #888; font-weight: normal; font-size: 0.9em; }
        .action-row.current { background: rgba(255,107,107,0.2); }
        .action-row.current td { font-weight: bold; }
        
        .chart-container { height: 280px; margin-top: 15px; }
        
        .loading { text-align: center; padding: 80px 20px; }
        .spinner { width: 50px; height: 50px; border: 4px solid #333; border-top-color: #ff6b6b; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .error-box { background: rgba(255,107,107,0.2); border: 1px solid #ff6b6b; padding: 25px; border-radius: 10px; text-align: center; }
        
        footer { text-align: center; padding: 20px; color: #555; font-size: 0.85em; margin-top: 30px; }
        
        @media (max-width: 768px) {
            .grid, .grid-2 { grid-template-columns: 1fr; }
            .score-display { gap: 15px; }
            .score-item { min-width: 100px; padding: 15px; }
            .score-value { font-size: 2em; }
            .rec-action { font-size: 1.8em; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ¯ å°è‚¡åšç©ºè¨Šè™Ÿè©•åˆ†ç³»çµ±</h1>
            <p class="subtitle">æ•´åˆæŠ€è¡“é¢ã€ç±Œç¢¼é¢ã€åƒ¹æ ¼å‹•èƒ½çš„å¤šç¶­åº¦åšç©ºè¨Šè™Ÿåˆ†æ</p>
            <p class="subtitle">è³‡æ–™æ—¥æœŸï¼š<span id="dataDate">è¼‰å…¥ä¸­...</span></p>
        </header>
        
        <div id="mainContent">
            <div class="loading">
                <div class="spinner"></div>
                <p>æ­£åœ¨è¼‰å…¥è³‡æ–™ä¸¦è¨ˆç®—æŒ‡æ¨™...</p>
            </div>
        </div>
        
        <footer>
            <p>âš ï¸ é¢¨éšªè­¦å‘Šï¼šåšç©ºæ“ä½œå…·æœ‰æ¥µé«˜é¢¨éšªï¼Œå¯èƒ½é€ æˆé‡å¤§è™§æã€‚æœ¬ç³»çµ±åƒ…ä¾›è³‡æ–™æ•´ç†åƒè€ƒï¼Œæ‰€æœ‰æŠ•è³‡æ±ºç­–èˆ‡ç›ˆè™§ç”±ä½¿ç”¨è€…è‡ªè¡Œæ‰¿æ“”ã€‚</p>
        </footer>
    </div>

<script>
// ============================================================
// GitHub Raw URL è¨­å®š - xlsx æª”æ¡ˆ
// ============================================================
const CONFIG = {
    TXINDEX_URL: 'https://raw.githubusercontent.com/rexdashu168/twindex/main/TXINDEX.xlsx',
    TSMC_URL: 'https://raw.githubusercontent.com/rexdashu168/twindex/main/2330.xlsx',
};

let processed = [];

window.onload = () => loadAllData();

async function loadAllData() {
    try {
        const [txData, tsmcData] = await Promise.all([
            fetchXLSX(CONFIG.TXINDEX_URL),
            fetchXLSX(CONFIG.TSMC_URL)
        ]);
        
        processData(txData, tsmcData);
    } catch (err) {
        console.error('Error:', err);
        document.getElementById('mainContent').innerHTML = `
            <div class="error-box">
                <h3>âŒ è¼‰å…¥å¤±æ•—</h3>
                <p style="margin-top:10px;color:#aaa;">${err.message}</p>
                <button onclick="loadAllData()" style="margin-top:15px;padding:10px 25px;background:#667eea;border:none;border-radius:5px;color:#fff;cursor:pointer;">é‡è©¦</button>
            </div>
        `;
    }
}

// è¼‰å…¥ä¸¦è§£æ XLSX
async function fetchXLSX(url) {
    const response = await fetch(url);
    if (!response.ok) throw new Error('ç„¡æ³•è¼‰å…¥æª”æ¡ˆ: ' + url);
    
    const buffer = await response.arrayBuffer();
    const workbook = XLSX.read(buffer, { type: 'array' });
    const sheetName = workbook.SheetNames[0];
    const sheet = workbook.Sheets[sheetName];
    const data = XLSX.utils.sheet_to_json(sheet, { raw: false });
    
    return data;
}

// è§£ææ•¸å­—ï¼ˆè™•ç†å„„ã€è¬ç­‰å–®ä½ï¼‰
function parseNum(v) {
    if (v === null || v === undefined || v === '' || v === 'NaN' || v === 'N/A') return NaN;
    let str = String(v).replace(/,/g, '');
    
    if (str.includes('å„„')) {
        return parseFloat(str.replace('å„„', '')) * 100000000;
    }
    if (str.includes('è¬')) {
        return parseFloat(str.replace('è¬', '')) * 10000;
    }
    return parseFloat(str);
}

// è§£ææ—¥æœŸ
function parseDate(v) {
    if (!v) return null;
    // è™•ç† Excel æ—¥æœŸæ ¼å¼
    if (typeof v === 'number') {
        const date = new Date((v - 25569) * 86400 * 1000);
        return date.toISOString().split('T')[0].replace(/-/g, '/');
    }
    return String(v).split(' ')[0]; // å–æ—¥æœŸéƒ¨åˆ†
}

function calcMA(data, field, period) {
    return data.map((_, i) => {
        if (i < period - 1) return NaN;
        let sum = 0;
        for (let j = 0; j < period; j++) sum += data[i - j][field];
        return sum / period;
    });
}

function calcRSI(data, field, period) {
    let result = [], gains = [], losses = [];
    for (let i = 0; i < data.length; i++) {
        if (i === 0) { result.push(50); continue; }
        let change = data[i][field] - data[i-1][field];
        gains.push(change > 0 ? change : 0);
        losses.push(change < 0 ? -change : 0);
        if (i < period) { result.push(50); }
        else {
            let avgG = gains.slice(-period).reduce((a,b)=>a+b,0) / period;
            let avgL = losses.slice(-period).reduce((a,b)=>a+b,0) / period;
            result.push(avgL === 0 ? 100 : 100 - (100 / (1 + avgG/avgL)));
        }
    }
    return result;
}

function calcMACD(data, field) {
    function ema(arr, period) {
        let result = [], k = 2 / (period + 1);
        for (let i = 0; i < arr.length; i++) {
            if (i === 0) result.push(arr[i]);
            else result.push(arr[i] * k + result[i-1] * (1-k));
        }
        return result;
    }
    let prices = data.map(d => d[field]);
    let ema12 = ema(prices, 12);
    let ema26 = ema(prices, 26);
    let dif = ema12.map((v, i) => v - ema26[i]);
    let macd = ema(dif, 9);
    let osc = dif.map((v, i) => v - macd[i]);
    return { dif, macd, osc };
}

function processData(txRaw, tsmcRaw) {
    // æ•´ç†åŠ æ¬ŠæŒ‡æ•¸
    let txData = txRaw.map(row => ({
        date: parseDate(row['æ™‚é–“']),
        close: parseNum(row['æ”¶ç›¤åƒ¹']),
        open: parseNum(row['é–‹ç›¤åƒ¹']),
        high: parseNum(row['æœ€é«˜åƒ¹']),
        low: parseNum(row['æœ€ä½åƒ¹']),
        volume: parseNum(row['æˆäº¤é‡']),
        foreign: parseNum(row['è²·è³£è¶…(å…ƒ)']),      // å¤–è³‡è²·è³£è¶…
        trust: parseNum(row['è²·è³£è¶…(å…ƒ).1']),      // æŠ•ä¿¡è²·è³£è¶…
        margin: parseNum(row['èè³‡(å…ƒ)'])          // èè³‡é¤˜é¡
    })).filter(d => !isNaN(d.close) && d.date);
    
    // æ•´ç†å°ç©é›»
    let tsmcMap = {};
    tsmcRaw.forEach(row => {
        let date = parseDate(row['æ™‚é–“']);
        let close = parseNum(row['æ”¶ç›¤åƒ¹']);
        if (date && !isNaN(close)) {
            tsmcMap[date] = close;
        }
    });
    
    // åˆä½µ
    let merged = txData.map(tx => ({
        ...tx,
        tsmcClose: tsmcMap[tx.date] || NaN
    })).filter(d => !isNaN(d.tsmcClose));
    
    // å–æœ€è¿‘ 150 å¤©
    merged = merged.slice(-150);
    
    if (merged.length < 60) {
        throw new Error('è³‡æ–™ä¸è¶³ï¼Œéœ€è¦è‡³å°‘60å¤©çš„è³‡æ–™');
    }
    
    // è¨ˆç®—æŒ‡æ¨™
    let ma5 = calcMA(merged, 'close', 5);
    let ma20 = calcMA(merged, 'close', 20);
    let ma60 = calcMA(merged, 'close', 60);
    let rsi = calcRSI(merged, 'close', 14);
    let { dif, macd, osc } = calcMACD(merged, 'close');
    
    let tsmcMa5 = calcMA(merged, 'tsmcClose', 5);
    let tsmcMa20 = calcMA(merged, 'tsmcClose', 20);
    let tsmcMa60 = calcMA(merged, 'tsmcClose', 60);
    let volMa20 = calcMA(merged, 'volume', 20);
    
    // çµ„åˆè³‡æ–™
    processed = merged.map((row, i) => {
        let dayRet = i > 0 ? (row.close / merged[i-1].close - 1) * 100 : 0;
        let tsmcRet = i > 0 ? (row.tsmcClose / merged[i-1].tsmcClose - 1) * 100 : 0;
        let bias20 = ma20[i] ? (row.close / ma20[i] - 1) * 100 : 0;
        
        // é€£è·Œå¤©æ•¸
        let downDays = 0;
        for (let j = i; j >= 0; j--) {
            if (j === 0 || merged[j].close < merged[j-1].close) downDays++;
            else break;
        }
        
        // å¤–è³‡é€£è³£å¤©æ•¸
        let foreignSellDays = 0;
        for (let j = i; j >= 0; j--) {
            if (merged[j].foreign < 0) foreignSellDays++;
            else break;
        }
        
        // èè³‡è®ŠåŒ–
        let marginChange = i >= 20 && merged[i-20].margin && row.margin ? 
            (row.margin / merged[i-20].margin - 1) * 100 : 0;
        
        // æ¼²å¹…
        let gain60 = i >= 60 ? (row.close / merged[i-60].close - 1) * 100 : 0;
        let gain120 = i >= 120 ? (row.close / merged[i-120].close - 1) * 100 : 0;
        
        // 52é€±é«˜
        let high52 = row.close;
        for (let j = 0; j < Math.min(240, i+1); j++) {
            if (merged[i-j].close > high52) high52 = merged[i-j].close;
        }
        let distHigh = (row.close / high52 - 1) * 100;
        
        // é‡æ¯”
        let volRatio = volMa20[i] && row.volume ? row.volume / volMa20[i] : 1;
        
        // MACD
        let prevOsc = i > 0 ? osc[i-1] : 0;
        let oscDecreasing = osc[i] < prevOsc;
        let macdDeathCross = i > 0 && dif[i] < macd[i] && dif[i-1] >= macd[i-1];
        
        return {
            date: row.date,
            close: row.close,
            dayRet,
            ma5: ma5[i],
            ma20: ma20[i],
            ma60: ma60[i],
            rsi: rsi[i],
            bias20,
            osc: osc[i],
            oscDecreasing,
            macdDeathCross,
            foreign: row.foreign,
            foreignSellDays,
            trust: row.trust,
            margin: row.margin,
            marginChange,
            tsmcClose: row.tsmcClose,
            tsmcRet,
            tsmcMa5: tsmcMa5[i],
            tsmcMa20: tsmcMa20[i],
            tsmcMa60: tsmcMa60[i],
            downDays,
            gain60,
            gain120,
            distHigh,
            volRatio
        };
    });
    
    renderDashboard();
}

function renderDashboard() {
    const d = processed[processed.length - 1];
    document.getElementById('dataDate').textContent = d.date;
    
    // å®šç¾©æŒ‡æ¨™
    const indicators = {
        overheat: [
            { name: 'RSI > 70', value: d.rsi, check: d.rsi > 70, weight: 1 },
            { name: 'RSI > 75', value: d.rsi, check: d.rsi > 75, weight: 1 },
            { name: 'ä¹–é›¢ç‡ > 3%', value: d.bias20, check: d.bias20 > 3, weight: 1 },
            { name: 'ä¹–é›¢ç‡ > 5%', value: d.bias20, check: d.bias20 > 5, weight: 1 },
            { name: 'èè³‡å¢ > 5%', value: d.marginChange, check: d.marginChange > 5, weight: 1 },
            { name: 'èè³‡å¢ > 7%', value: d.marginChange, check: d.marginChange > 7, weight: 1 },
            { name: '60æ—¥æ¼² > 15%', value: d.gain60, check: d.gain60 > 15, weight: 1 },
            { name: '120æ—¥æ¼² > 25%', value: d.gain120, check: d.gain120 > 25, weight: 1 },
            { name: 'æ¥è¿‘52é€±é«˜', value: d.distHigh, check: d.distHigh > -3, weight: 1 },
        ],
        price: [
            { name: 'æ”¶é»‘K', value: d.dayRet, check: d.dayRet < 0, weight: 1 },
            { name: 'å¤§é»‘K (>1%)', value: d.dayRet, check: d.dayRet < -1, weight: 2 },
            { name: 'å¤§é»‘K (>2%)', value: d.dayRet, check: d.dayRet < -2, weight: 3 },
            { name: 'è·Œç ´5æ—¥å‡', value: d.close, check: d.close < d.ma5, weight: 1 },
            { name: 'è·Œç ´20æ—¥å‡', value: d.close, check: d.close < d.ma20, weight: 2 },
            { name: 'è·Œç ´60æ—¥å‡', value: d.close, check: d.close < d.ma60, weight: 3 },
            { name: 'é€£è·Œ2å¤©', value: d.downDays, check: d.downDays >= 2, weight: 1 },
            { name: 'é€£è·Œ3å¤©', value: d.downDays, check: d.downDays >= 3, weight: 2 },
        ],
        chip: [
            { name: 'å¤–è³‡è³£è¶…', value: d.foreign, check: d.foreign < 0, weight: 2 },
            { name: 'å¤–è³‡é€£è³£2å¤©', value: d.foreignSellDays, check: d.foreignSellDays >= 2, weight: 2 },
            { name: 'å¤–è³‡é€£è³£3å¤©', value: d.foreignSellDays, check: d.foreignSellDays >= 3, weight: 3 },
            { name: 'å¤–è³‡é€£è³£5å¤©', value: d.foreignSellDays, check: d.foreignSellDays >= 5, weight: 4 },
            { name: 'æŠ•ä¿¡è³£è¶…', value: d.trust, check: d.trust < 0, weight: 1 },
        ],
        technical: [
            { name: 'RSI < 50', value: d.rsi, check: d.rsi < 50, weight: 1 },
            { name: 'RSI < 40', value: d.rsi, check: d.rsi < 40, weight: 2 },
            { name: 'RSI < 30', value: d.rsi, check: d.rsi < 30, weight: 3 },
            { name: 'MACDæ­»å‰', value: d.macdDeathCross ? 'æ˜¯' : 'å¦', check: d.macdDeathCross, weight: 2 },
            { name: 'OSCæŸ±ç¸®æ¸›', value: d.oscDecreasing ? 'æ˜¯' : 'å¦', check: d.oscDecreasing && d.osc > 0, weight: 1 },
            { name: 'OSCè½‰è² ', value: d.osc, check: d.osc < 0, weight: 2 },
        ],
        tsmc: [
            { name: 'å°ç©é›»æ”¶é»‘', value: d.tsmcRet, check: d.tsmcRet < 0, weight: 1 },
            { name: 'å°ç©é›»è·Œ>1%', value: d.tsmcRet, check: d.tsmcRet < -1, weight: 2 },
            { name: 'å°ç©é›»è·Œ>2%', value: d.tsmcRet, check: d.tsmcRet < -2, weight: 3 },
            { name: 'å°ç©ç ´20å‡', value: d.tsmcClose, check: d.tsmcClose < d.tsmcMa20, weight: 2 },
            { name: 'å°ç©ç ´60å‡', value: d.tsmcClose, check: d.tsmcClose < d.tsmcMa60, weight: 3 },
        ],
        volume: [
            { name: 'é‡ç¸®(<0.8å€)', value: d.volRatio, check: d.volRatio < 0.8, weight: 1 },
            { name: 'çˆ†é‡æ”¶é»‘', value: d.volRatio, check: d.volRatio > 1.5 && d.dayRet < 0, weight: 2 },
        ]
    };
    
    // è¨ˆç®—åˆ†æ•¸
    let overheatScore = indicators.overheat.filter(i => i.check).reduce((s,i) => s + i.weight, 0);
    let priceScore = indicators.price.filter(i => i.check).reduce((s,i) => s + i.weight, 0);
    let chipScore = indicators.chip.filter(i => i.check).reduce((s,i) => s + i.weight, 0);
    let techScore = indicators.technical.filter(i => i.check).reduce((s,i) => s + i.weight, 0);
    let tsmcScore = indicators.tsmc.filter(i => i.check).reduce((s,i) => s + i.weight, 0);
    let volScore = indicators.volume.filter(i => i.check).reduce((s,i) => s + i.weight, 0);
    
    let shortScore = priceScore + chipScore + techScore + tsmcScore + volScore;
    let totalTriggered = 
        indicators.price.filter(i => i.check).length +
        indicators.chip.filter(i => i.check).length +
        indicators.technical.filter(i => i.check).length +
        indicators.tsmc.filter(i => i.check).length +
        indicators.volume.filter(i => i.check).length;
    
    function getWinRate(score) {
        if (score >= 24) return { rate: 48.5, big: 13.9 };
        if (score >= 20) return { rate: 49.0, big: 14.1 };
        if (score >= 16) return { rate: 48.2, big: 13.5 };
        if (score >= 12) return { rate: 46.9, big: 13.1 };
        if (score >= 8) return { rate: 46.1, big: 12.3 };
        if (score >= 4) return { rate: 45.6, big: 11.3 };
        return { rate: 44.3, big: 9.3 };
    }
    
    let winData = getWinRate(shortScore);
    
    function getRecommendation(overheat, shortScore, d) {
        if (d.close < d.ma60 && d.tsmcClose < d.tsmcMa60 && shortScore >= 16) {
            return { level: 'heavy', action: 'ğŸ”¥ å¼·åŠ›åšç©º', detail: `ç©ºæ–¹ç¸½åˆ†${shortScore}åˆ†ï¼Œåƒ¹æ ¼å·²ç ´60æ—¥å‡ç·šï¼Œå°ç©é›»åŒæ­¥ç ´ç·š<br>æ­·å²10æ—¥ä¸‹è·Œæ©Ÿç‡: ${winData.rate}%ï¼Œå¤§è·Œæ©Ÿç‡: ${winData.big}%<br><b>å»ºè­°ï¼šç©æ¥µåšç©ºï¼Œéƒ¨ä½å¯é”80%ï¼Œåœæè¨­åœ¨åå½ˆé«˜é»ä¸Šæ–¹1%</b>`, class: 'rec-heavy' };
        }
        if (d.close < d.ma60 && shortScore >= 12) {
            return { level: 'add', action: 'ğŸ“‰ åŠ ç¢¼åšç©º', detail: `ç©ºæ–¹ç¸½åˆ†${shortScore}åˆ†ï¼Œåƒ¹æ ¼å·²è·Œç ´60æ—¥å‡ç·š<br><b>å»ºè­°ï¼šåŠ ç¢¼ç©ºå–®è‡³50%ï¼Œåœæè¨­åœ¨60æ—¥å‡ç·šä¸Šæ–¹2%</b>`, class: 'rec-add' };
        }
        if (d.close < d.ma20 && shortScore >= 8) {
            return { level: 'build', action: 'ğŸ“Š å»ºå€‰åšç©º', detail: `ç©ºæ–¹ç¸½åˆ†${shortScore}åˆ†ï¼Œåƒ¹æ ¼å·²è·Œç ´20æ—¥å‡ç·š<br><b>å»ºè­°ï¼šå»ºç«‹30%ç©ºå–®éƒ¨ä½ï¼Œåœæè¨­åœ¨20æ—¥å‡ç·šä¸Šæ–¹2%</b>`, class: 'rec-build' };
        }
        if (overheat >= 5 && shortScore >= 6) {
            return { level: 'trial', action: 'ğŸ¯ è©¦å–®åšç©º', detail: `éç†±åˆ†æ•¸${overheat}/9ï¼Œç©ºæ–¹ç¸½åˆ†${shortScore}åˆ†<br><b>å»ºè­°ï¼šè©¦å–®10%ï¼Œåœæè¨­åœ¨é€²å ´åƒ¹ä¸Šæ–¹3%</b>`, class: 'rec-trial' };
        }
        if (overheat >= 5) {
            return { level: 'prepare', action: 'âš¡ æº–å‚™åšç©º', detail: `éç†±åˆ†æ•¸${overheat}/9ï¼Œä½†ç©ºæ–¹è¨Šè™Ÿå°šä¸è¶³<br><b>å»ºè­°ï¼šæº–å‚™è³‡é‡‘ï¼Œç­‰å¾…æ”¶é»‘+å¤–è³‡è³£è¶…+å°ç©è½‰å¼±</b>`, class: 'rec-prepare' };
        }
        if (overheat >= 3) {
            return { level: 'watch', action: 'ğŸ‘€ å¯†åˆ‡è§€å¯Ÿ', detail: `éç†±åˆ†æ•¸${overheat}/9ï¼Œå¸‚å ´é–‹å§‹å‡æº«<br><b>å»ºè­°ï¼šæŒçºŒè§€å¯Ÿï¼Œå°šæœªåˆ°æœ€ä½³åšç©ºæ™‚æ©Ÿ</b>`, class: 'rec-watch' };
        }
        return { level: 'wait', action: 'â³ ç­‰å¾…æ™‚æ©Ÿ', detail: `éç†±åˆ†æ•¸${overheat}/9ï¼Œå¸‚å ´å°šæœªéç†±<br><b>å»ºè­°ï¼šä¿æŒè§€æœ›ï¼Œç­‰å¾…éç†±è¨Šè™Ÿå‡ºç¾</b>`, class: 'rec-wait' };
    }
    
    let rec = getRecommendation(overheatScore, shortScore, d);
    
    // æ¸²æŸ“
    let html = `
        <div class="recommendation-box ${rec.class}">
            <div class="rec-title">ğŸ“Œ ä»Šæ—¥æ“ä½œå»ºè­°</div>
            <div class="rec-action">${rec.action}</div>
            <div class="rec-detail">${rec.detail}</div>
        </div>
        
        <div class="score-display">
            <div class="score-item">
                <div class="score-value" style="color:${overheatScore >= 5 ? '#ff6b6b' : '#feca57'}">${overheatScore}</div>
                <div class="score-label">éç†±åˆ†æ•¸ /9</div>
            </div>
            <div class="score-item">
                <div class="score-value" style="color:${shortScore >= 16 ? '#ff0000' : shortScore >= 8 ? '#ff6b6b' : '#48dbfb'}">${shortScore}</div>
                <div class="score-label">ç©ºæ–¹ç¸½åˆ†</div>
            </div>
            <div class="score-item">
                <div class="score-value">${totalTriggered}</div>
                <div class="score-label">è§¸ç™¼è¨Šè™Ÿæ•¸</div>
            </div>
            <div class="score-item">
                <div class="score-value" style="color:${winData.rate >= 48 ? '#ff6b6b' : '#feca57'}">${winData.rate}%</div>
                <div class="score-label">æ­·å²10æ—¥è·Œç‡</div>
            </div>
        </div>
        
        <div class="grid">
            <div class="card">
                <div class="card-title">ğŸ“Š åŠ æ¬ŠæŒ‡æ•¸</div>
                <div class="price-box">
                    <div class="price-main">${d.close.toLocaleString()}</div>
                    <div class="price-change ${d.dayRet >= 0 ? 'up' : 'down'}">${d.dayRet >= 0 ? 'â–²' : 'â–¼'} ${Math.abs(d.dayRet).toFixed(2)}%</div>
                </div>
                <div class="ma-grid">
                    <div class="ma-item ${d.close > d.ma5 ? 'above' : 'below'}"><div class="value">${d.ma5?.toFixed(0) || '-'}</div><div class="label">5æ—¥å‡</div></div>
                    <div class="ma-item ${d.close > d.ma20 ? 'above' : 'below'}"><div class="value">${d.ma20?.toFixed(0) || '-'}</div><div class="label">20æ—¥å‡</div></div>
                    <div class="ma-item ${d.close > d.ma60 ? 'above' : 'below'}"><div class="value">${d.ma60?.toFixed(0) || '-'}</div><div class="label">60æ—¥å‡</div></div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">ğŸ­ å°ç©é›»</div>
                <div class="price-box">
                    <div class="price-main">${d.tsmcClose.toLocaleString()}</div>
                    <div class="price-change ${d.tsmcRet >= 0 ? 'up' : 'down'}">${d.tsmcRet >= 0 ? 'â–²' : 'â–¼'} ${Math.abs(d.tsmcRet).toFixed(2)}%</div>
                </div>
                <div class="ma-grid">
                    <div class="ma-item ${d.tsmcClose > d.tsmcMa5 ? 'above' : 'below'}"><div class="value">${d.tsmcMa5?.toFixed(0) || '-'}</div><div class="label">5æ—¥å‡</div></div>
                    <div class="ma-item ${d.tsmcClose > d.tsmcMa20 ? 'above' : 'below'}"><div class="value">${d.tsmcMa20?.toFixed(0) || '-'}</div><div class="label">20æ—¥å‡</div></div>
                    <div class="ma-item ${d.tsmcClose > d.tsmcMa60 ? 'above' : 'below'}"><div class="value">${d.tsmcMa60?.toFixed(0) || '-'}</div><div class="label">60æ—¥å‡</div></div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">ğŸ’° ç±Œç¢¼é¢ (åˆ†æ•¸: ${chipScore})</div>
                ${renderIndicators(indicators.chip)}
            </div>
        </div>
        
        <div class="grid grid-2">
            <div class="card">
                <div class="card-title">ğŸŒ¡ï¸ éç†±æŒ‡æ¨™ (åˆ†æ•¸: ${overheatScore}/9)</div>
                ${renderIndicators(indicators.overheat)}
            </div>
            <div class="card">
                <div class="card-title">ğŸ“ˆ åƒ¹æ ¼è¨Šè™Ÿ (åˆ†æ•¸: ${priceScore})</div>
                ${renderIndicators(indicators.price)}
            </div>
        </div>
        
        <div class="grid grid-2">
            <div class="card">
                <div class="card-title">ğŸ“‰ æŠ€è¡“æŒ‡æ¨™ (åˆ†æ•¸: ${techScore})</div>
                ${renderIndicators(indicators.technical)}
            </div>
            <div class="card">
                <div class="card-title">ğŸ­ å°ç©é›»è¨Šè™Ÿ (åˆ†æ•¸: ${tsmcScore})</div>
                ${renderIndicators(indicators.tsmc)}
            </div>
        </div>
        
        <div class="card">
            <div class="card-title">ğŸ“‹ é‡‘å­—å¡”åšç©ºç­–ç•¥å°ç…§è¡¨</div>
            <table class="action-table">
                <tr><th>éšæ®µ</th><th>æ¢ä»¶</th><th>å»ºè­°éƒ¨ä½</th><th>åœæ</th><th>ç‹€æ…‹</th></tr>
                <tr class="action-row ${rec.level === 'wait' || rec.level === 'watch' ? 'current' : ''}"><td>è§€å¯ŸæœŸ</td><td>éç†±åˆ†æ•¸ â‰¥ 3</td><td>0%</td><td>-</td><td>${overheatScore >= 3 ? 'âœ“' : '-'}</td></tr>
                <tr class="action-row ${rec.level === 'prepare' ? 'current' : ''}"><td>æº–å‚™æœŸ</td><td>éç†±åˆ†æ•¸ â‰¥ 5</td><td>0%</td><td>-</td><td>${overheatScore >= 5 ? 'âœ“' : '-'}</td></tr>
                <tr class="action-row ${rec.level === 'trial' ? 'current' : ''}"><td>è©¦å–®æœŸ</td><td>éç†±â‰¥5 + ç©ºæ–¹â‰¥6</td><td>10%</td><td>é€²å ´+3%</td><td>${overheatScore >= 5 && shortScore >= 6 ? 'âœ“' : '-'}</td></tr>
                <tr class="action-row ${rec.level === 'build' ? 'current' : ''}"><td>å»ºå€‰æœŸ</td><td>è·Œç ´20å‡ + ç©ºæ–¹â‰¥8</td><td>30%</td><td>20å‡+2%</td><td>${d.close < d.ma20 && shortScore >= 8 ? 'âœ“' : '-'}</td></tr>
                <tr class="action-row ${rec.level === 'add' ? 'current' : ''}"><td>åŠ ç¢¼æœŸ</td><td>è·Œç ´60å‡ + ç©ºæ–¹â‰¥12</td><td>50%</td><td>60å‡+2%</td><td>${d.close < d.ma60 && shortScore >= 12 ? 'âœ“' : '-'}</td></tr>
                <tr class="action-row ${rec.level === 'heavy' ? 'current' : ''}"><td>é‡å£“æœŸ</td><td>ç ´60å‡+å°ç©ç ´60å‡+ç©ºæ–¹â‰¥16</td><td>80%</td><td>é«˜é»+1%</td><td>${d.close < d.ma60 && d.tsmcClose < d.tsmcMa60 && shortScore >= 16 ? 'âœ“' : '-'}</td></tr>
            </table>
        </div>
        
        <div class="card">
            <div class="card-title">ğŸ“ˆ è¿‘æœŸèµ°å‹¢</div>
            <div class="chart-container"><canvas id="priceChart"></canvas></div>
        </div>
    `;
    
    document.getElementById('mainContent').innerHTML = html;
    renderChart();
}

function renderIndicators(list) {
    return list.map(ind => {
        let val = typeof ind.value === 'number' ? 
            (Math.abs(ind.value) >= 1e8 ? (ind.value/1e8).toFixed(1) + 'å„„' : ind.value.toFixed(2)) : 
            ind.value;
        return `<div class="indicator-item ${ind.check ? 'triggered' : ''}">
            <span class="ind-name">${ind.name}</span>
            <span class="ind-value">${val}</span>
            <span class="ind-weight">${ind.check ? '+' + ind.weight : ''}</span>
            <span class="ind-status">${ind.check ? 'ğŸ”´' : 'âšª'}</span>
        </div>`;
    }).join('');
}

function renderChart() {
    const ctx = document.getElementById('priceChart').getContext('2d');
    const last40 = processed.slice(-40);
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: last40.map(d => d.date.slice(5)),
            datasets: [
                { label: 'åŠ æ¬ŠæŒ‡æ•¸', data: last40.map(d => d.close), borderColor: '#48dbfb', backgroundColor: 'rgba(72,219,251,0.1)', fill: true, tension: 0.3 },
                { label: '20æ—¥å‡', data: last40.map(d => d.ma20), borderColor: '#feca57', borderDash: [5,5], fill: false, tension: 0.3, pointRadius: 0 },
                { label: '60æ—¥å‡', data: last40.map(d => d.ma60), borderColor: '#ff6b6b', borderDash: [5,5], fill: false, tension: 0.3, pointRadius: 0 }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { labels: { color: '#888' } } },
            scales: {
                x: { ticks: { color: '#666' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                y: { ticks: { color: '#666' }, grid: { color: 'rgba(255,255,255,0.05)' } }
            }
        }
    });
}
</script>
</body>
</html>
