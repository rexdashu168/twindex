<!DOCTYPE html>

<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°è‚¡åšç©ºè¨Šè™Ÿç³»çµ± Pro v4</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: "Microsoft JhengHei", sans-serif; background: linear-gradient(135deg, #0f0f23 0%, #1a1a3e 100%); color: #eee; min-height: 100vh; padding: 12px; }
        .container { max-width: 1600px; margin: 0 auto; }
        header { text-align: center; padding: 15px; background: rgba(255,255,255,0.03); border-radius: 12px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.1); }
        header h1 { font-size: 1.6em; background: linear-gradient(90deg, #ff416c, #ff4b2b, #f7971e); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .subtitle { color: #888; margin-top: 6px; font-size: 0.85em; }
        .recommendation-box { background: linear-gradient(135deg, rgba(255,65,108,0.15), rgba(255,75,43,0.15)); border: 2px solid; border-radius: 15px; padding: 20px; margin-bottom: 15px; text-align: center; }
        .rec-title { font-size: 1.1em; margin-bottom: 10px; }
        .rec-action { font-size: 2em; font-weight: bold; margin: 10px 0; }
        .rec-detail { font-size: 0.95em; color: #ccc; line-height: 1.7; }
        .rec-wait { border-color: #666; } .rec-watch { border-color: #feca57; } .rec-prepare { border-color: #ff9f43; }
        .rec-trial { border-color: #ff6b6b; } .rec-build { border-color: #ee5a24; } .rec-add { border-color: #eb2f06; }
        .rec-heavy { border-color: #ff0000; animation: glow 1.5s infinite; }
        @keyframes glow { 0%, 100% { box-shadow: 0 0 15px rgba(255,0,0,0.3); } 50% { box-shadow: 0 0 30px rgba(255,0,0,0.6); } }
        .score-display { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin: 15px 0; }
        .score-item { text-align: center; padding: 10px 12px; background: rgba(255,255,255,0.05); border-radius: 10px; min-width: 75px; }
        .score-value { font-size: 1.6em; font-weight: bold; }
        .score-label { color: #888; margin-top: 3px; font-size: 0.7em; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 10px; margin-bottom: 10px; }
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); }
        .grid-3 { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
        .card { background: rgba(255,255,255,0.03); border-radius: 10px; padding: 12px; border: 1px solid rgba(255,255,255,0.08); }
        .card-title { font-size: 0.85em; color: #48dbfb; margin-bottom: 8px; padding-bottom: 5px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; }
        .card-score { background: rgba(255,107,107,0.2); padding: 2px 7px; border-radius: 8px; font-size: 0.8em; }
        .indicator-item { display: flex; justify-content: space-between; align-items: center; padding: 4px 5px; margin: 2px 0; background: rgba(255,255,255,0.02); border-radius: 4px; border-left: 3px solid transparent; font-size: 0.75em; }
        .indicator-item.triggered { background: rgba(255,107,107,0.15); border-left-color: #ff6b6b; }
        .ind-name { flex: 1; } .ind-value { min-width: 65px; text-align: right; font-family: monospace; font-size: 0.8em; color: #aaa; }
        .ind-weight { min-width: 28px; text-align: center; font-size: 0.65em; color: #ff6b6b; } .ind-status { min-width: 14px; text-align: center; }
        .price-box { text-align: center; padding: 5px; }
        .price-main { font-size: 1.4em; font-weight: bold; }
        .price-change { font-size: 0.8em; margin-top: 2px; }
        .up { color: #ff6b6b; } .down { color: #26de81; }
        .ma-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 2px; margin-top: 5px; }
        .ma-item { text-align: center; padding: 3px 2px; background: rgba(255,255,255,0.03); border-radius: 3px; }
        .ma-item .value { font-size: 0.75em; font-weight: bold; } .ma-item .label { font-size: 0.5em; color: #888; }
        .ma-item.above { border-bottom: 2px solid #26de81; } .ma-item.below { border-bottom: 2px solid #ff6b6b; }
        .alert-box { border-radius: 8px; padding: 10px; margin: 8px 0; text-align: center; }
        .alert-red { background: linear-gradient(135deg, rgba(255,0,0,0.2), rgba(200,0,0,0.2)); border: 1px solid #ff4444; }
        .alert-yellow { background: linear-gradient(135deg, rgba(255,193,7,0.2), rgba(255,152,0,0.2)); border: 1px solid #ffc107; }
        .alert-orange { background: linear-gradient(135deg, rgba(255,152,0,0.2), rgba(255,87,34,0.2)); border: 1px solid #ff9800; }
        .alert-box h4 { margin-bottom: 4px; font-size: 0.9em; }
        .alert-box p { font-size: 0.8em; color: #ccc; }
        .phase-box { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin: 8px 0; }
        .phase-item { text-align: center; padding: 8px 4px; background: rgba(255,255,255,0.03); border-radius: 6px; border: 2px solid transparent; }
        .phase-item.active { border-color: #feca57; background: rgba(254,202,87,0.1); }
        .phase-item .phase-name { font-size: 0.7em; color: #888; }
        .phase-item .phase-label { font-size: 0.85em; font-weight: bold; margin: 2px 0; }
        .phase-item .phase-hint { font-size: 0.6em; color: #666; }
        .margin-stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; margin-top: 6px; }
        .margin-stat { text-align: center; padding: 6px; background: rgba(255,255,255,0.02); border-radius: 5px; }
        .margin-stat .stat-value { font-size: 1em; font-weight: bold; }
        .margin-stat .stat-label { font-size: 0.65em; color: #888; }
        .future-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-top: 6px; }
        .future-stat { text-align: center; padding: 8px 4px; background: rgba(255,255,255,0.02); border-radius: 5px; }
        .future-stat .stat-value { font-size: 1.1em; font-weight: bold; }
        .future-stat .stat-label { font-size: 0.6em; color: #888; }
        .future-stat.bullish .stat-value { color: #ff6b6b; }
        .future-stat.bearish .stat-value { color: #26de81; }
        .action-table { width: 100%; margin-top: 6px; font-size: 0.7em; }
        .action-table th, .action-table td { padding: 5px 2px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.08); }
        .action-table th { color: #888; font-weight: normal; } .action-row.current { background: rgba(255,107,107,0.2); }
        .chart-container { height: 160px; margin-top: 6px; }
        .loading { text-align: center; padding: 50px 15px; }
        .spinner { width: 35px; height: 35px; border: 3px solid #333; border-top-color: #ff6b6b; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 12px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .error-box { background: rgba(255,107,107,0.2); border: 1px solid #ff6b6b; padding: 15px; border-radius: 8px; text-align: center; }
        .status-box { background: rgba(255,193,7,0.1); border: 1px solid #ffc107; padding: 10px; border-radius: 8px; margin: 10px 0; font-size: 0.8em; }
        .debug-box { background: rgba(100,100,100,0.2); border: 1px solid #666; padding: 10px; border-radius: 8px; margin: 10px 0; font-size: 0.75em; font-family: monospace; white-space: pre-wrap; max-height: 200px; overflow-y: auto; }
        footer { text-align: center; padding: 10px; color: #555; font-size: 0.65em; margin-top: 12px; }
        @media (max-width: 768px) { .grid, .grid-2, .grid-3 { grid-template-columns: 1fr; } .score-display { gap: 5px; } .score-item { min-width: 55px; padding: 7px 5px; } .score-value { font-size: 1.3em; } .rec-action { font-size: 1.2em; } .phase-box { grid-template-columns: repeat(2, 1fr); } .future-stats { grid-template-columns: repeat(2, 1fr); } }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>å°è‚¡åšç©ºè¨Šè™Ÿç³»çµ± Pro v4</h1>
        <p class="subtitle">å‡ç·šç³»çµ± + èè³‡å¾ªç’° + æœŸè²¨ç±Œç¢¼ + OTCé ˜å…ˆ + å°ç©é›»</p>
        <p class="subtitle">è³‡æ–™æ—¥æœŸï¼š<span id="dataDate">è¼‰å…¥ä¸­...</span></p>
    </header>
    <div id="mainContent">
        <div class="loading">
            <div class="spinner"></div>
            <p>æ­£åœ¨è¼‰å…¥è³‡æ–™...</p>
            <p id="loadStatus" style="margin-top:10px;font-size:0.8em;color:#888;"></p>
        </div>
    </div>
    <div id="debugLog" class="debug-box" style="display:none;"></div>
    <footer><p>æœ¬ç³»çµ±åƒ…ä¾›è³‡æ–™æ•´ç†åƒè€ƒï¼Œä¸æ§‹æˆæŠ•è³‡å»ºè­°ã€‚åšç©ºé¢¨éšªæ¥µé«˜ï¼ŒæŠ•è³‡æ±ºç­–è«‹è‡ªè¡Œåˆ¤æ–·ã€‚</p></footer>
</div>
<script>
(function() {
    var debugLog = [];
    function log(msg) {
        debugLog.push(new Date().toLocaleTimeString() + ": " + msg);
        console.log(msg);
        var el = document.getElementById("debugLog");
        if (el) {
            el.style.display = "block";
            el.textContent = debugLog.join("\n");
        }
    }

```
var CONFIG = {
    TXINDEX_URL: "https://raw.githubusercontent.com/rexdashu168/twindex/main/TXINDEX.xlsx",
    OTC_URL: "https://raw.githubusercontent.com/rexdashu168/twindex/main/OTCindex.xlsx",
    TSMC_URL: "https://raw.githubusercontent.com/rexdashu168/twindex/main/2330.xlsx",
    FUTURE_URL: "https://raw.githubusercontent.com/rexdashu168/twindex/main/future_index.xlsx"
};
var processed = [];
var hasFutureData = false;

window.onerror = function(msg, url, line, col, error) {
    log("JS Error: " + msg + " at line " + line);
    return false;
};

window.onload = function() {
    log("é é¢è¼‰å…¥å®Œæˆï¼Œé–‹å§‹åˆå§‹åŒ–...");
    
    if (typeof XLSX === "undefined") {
        log("éŒ¯èª¤: XLSX å‡½å¼åº«æœªè¼‰å…¥");
        showError("XLSX å‡½å¼åº«è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š");
        return;
    }
    log("XLSX å‡½å¼åº«å·²è¼‰å…¥");
    
    if (typeof Chart === "undefined") {
        log("è­¦å‘Š: Chart.js æœªè¼‰å…¥");
    } else {
        log("Chart.js å·²è¼‰å…¥");
    }
    
    loadAllData();
};

function showError(msg) {
    document.getElementById("mainContent").innerHTML = 
        '<div class="error-box"><h3>è¼‰å…¥å¤±æ•—</h3><p style="margin-top:8px;color:#aaa;">' + msg + 
        '</p><button onclick="location.reload()" style="margin-top:12px;padding:8px 20px;background:#667eea;border:none;border-radius:5px;color:#fff;cursor:pointer;">é‡è©¦</button></div>';
}

function updateStatus(msg) {
    log(msg);
    var el = document.getElementById("loadStatus");
    if (el) el.textContent = msg;
}

async function loadAllData() {
    try {
        updateStatus("è¼‰å…¥åŠ æ¬ŠæŒ‡æ•¸...");
        var txData = await fetchXLSX(CONFIG.TXINDEX_URL, "TXINDEX");
        
        updateStatus("è¼‰å…¥OTCæŒ‡æ•¸...");
        var otcData = await fetchXLSX(CONFIG.OTC_URL, "OTC");
        
        updateStatus("è¼‰å…¥å°ç©é›»...");
        var tsmcData = await fetchXLSX(CONFIG.TSMC_URL, "2330");
        
        var futureData = null;
        try {
            updateStatus("è¼‰å…¥æœŸè²¨è³‡æ–™...");
            futureData = await fetchXLSX(CONFIG.FUTURE_URL, "Future");
            hasFutureData = true;
            log("æœŸè²¨è³‡æ–™è¼‰å…¥æˆåŠŸ");
        } catch (e) {
            log("æœŸè²¨è³‡æ–™è¼‰å…¥å¤±æ•—: " + e.message);
            hasFutureData = false;
        }
        
        updateStatus("è™•ç†è³‡æ–™ä¸­...");
        processData(txData, otcData, tsmcData, futureData);
        
    } catch (err) {
        log("è¼‰å…¥éŒ¯èª¤: " + err.message);
        showError(err.message);
    }
}

async function fetchXLSX(url, name) {
    log("é–‹å§‹è¼‰å…¥: " + name + " from " + url);
    
    var response;
    try {
        response = await fetch(url);
    } catch (e) {
        throw new Error(name + " ç¶²è·¯è«‹æ±‚å¤±æ•—: " + e.message);
    }
    
    log(name + " HTTPç‹€æ…‹: " + response.status);
    
    if (!response.ok) {
        throw new Error(name + " è¼‰å…¥å¤±æ•— (HTTP " + response.status + ")");
    }
    
    var buffer;
    try {
        buffer = await response.arrayBuffer();
    } catch (e) {
        throw new Error(name + " è®€å–è³‡æ–™å¤±æ•—: " + e.message);
    }
    
    log(name + " è³‡æ–™å¤§å°: " + buffer.byteLength + " bytes");
    
    var workbook;
    try {
        workbook = XLSX.read(buffer, { type: "array" });
    } catch (e) {
        throw new Error(name + " Excelè§£æå¤±æ•—: " + e.message);
    }
    
    var sheetName = workbook.SheetNames[0];
    log(name + " å·¥ä½œè¡¨: " + sheetName);
    
    var data = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { raw: false });
    log(name + " è³‡æ–™ç­†æ•¸: " + data.length);
    
    return data;
}

function parseNum(v) {
    if (v === null || v === undefined || v === "" || v === "NaN" || v === "N/A") return NaN;
    var s = String(v).replace(/,/g, "");
    if (s.indexOf("å„„") >= 0) return parseFloat(s.replace("å„„", "")) * 1e8;
    if (s.indexOf("è¬") >= 0) return parseFloat(s.replace("è¬", "")) * 1e4;
    return parseFloat(s);
}

function parseDate(v) {
    if (!v) return null;
    if (typeof v === "number") {
        var d = new Date((v - 25569) * 86400 * 1000);
        return d.toISOString().split("T")[0].replace(/-/g, "/");
    }
    return String(v).split(" ")[0];
}

function calcMA(data, field, period) {
    var result = [];
    for (var i = 0; i < data.length; i++) {
        if (i < period - 1) {
            result.push(NaN);
        } else {
            var sum = 0;
            for (var j = 0; j < period; j++) {
                sum += data[i - j][field];
            }
            result.push(sum / period);
        }
    }
    return result;
}

function calcRSI(data, field, period) {
    var result = [];
    var gains = [];
    var losses = [];
    for (var i = 0; i < data.length; i++) {
        if (i === 0) {
            result.push(50);
            continue;
        }
        var change = data[i][field] - data[i-1][field];
        gains.push(change > 0 ? change : 0);
        losses.push(change < 0 ? -change : 0);
        if (i < period) {
            result.push(50);
        } else {
            var sumG = 0, sumL = 0;
            for (var j = gains.length - period; j < gains.length; j++) {
                sumG += gains[j];
                sumL += losses[j];
            }
            var avgG = sumG / period;
            var avgL = sumL / period;
            result.push(avgL === 0 ? 100 : 100 - (100 / (1 + avgG/avgL)));
        }
    }
    return result;
}

function processData(txRaw, otcRaw, tsmcRaw, futureRaw) {
    log("é–‹å§‹è™•ç†è³‡æ–™...");
    
    var txData = [];
    for (var i = 0; i < txRaw.length; i++) {
        var row = txRaw[i];
        var item = {
            date: parseDate(row["æ™‚é–“"]),
            close: parseNum(row["æ”¶ç›¤åƒ¹"]),
            foreign: parseNum(row["è²·è³£è¶…(å…ƒ)"]),
            trust: parseNum(row["è²·è³£è¶…(å…ƒ).1"]),
            margin: parseNum(row["èè³‡(å…ƒ)"]),
            marginChg: parseNum(row["å·®é¡(å…ƒ)"])
        };
        if (!isNaN(item.close) && item.date) {
            txData.push(item);
        }
    }
    log("åŠ æ¬Šè³‡æ–™è™•ç†å®Œæˆ: " + txData.length + " ç­†");

    var otcMap = {};
    var otcMarginMap = {};
    for (var i = 0; i < otcRaw.length; i++) {
        var row = otcRaw[i];
        var date = parseDate(row["æ™‚é–“"]);
        if (date) {
            otcMap[date] = parseNum(row["æ”¶ç›¤åƒ¹"]);
            otcMarginMap[date] = parseNum(row["èè³‡(å…ƒ)"]);
        }
    }
    log("OTCè³‡æ–™è™•ç†å®Œæˆ");

    var tsmcMap = {};
    for (var i = 0; i < tsmcRaw.length; i++) {
        var row = tsmcRaw[i];
        var date = parseDate(row["æ™‚é–“"]);
        if (date) {
            tsmcMap[date] = parseNum(row["æ”¶ç›¤åƒ¹"]);
        }
    }
    log("å°ç©é›»è³‡æ–™è™•ç†å®Œæˆ");

    var futureMap = {};
    if (futureRaw) {
        for (var i = 0; i < futureRaw.length; i++) {
            var row = futureRaw[i];
            var date = parseDate(row["æ™‚é–“"]);
            if (date) {
                futureMap[date] = {
                    vix: parseNum(row["VIX(ææ…ŒæŒ‡æ•¸)"]),
                    foreignOI: parseNum(row["å¤–è³‡åŠé™¸è³‡æœªå¹³å€‰æ·¨å£"]),
                    instOI: parseNum(row["ä¸‰å¤§æ³•äººæœªå¹³å€‰æ·¨å£"])
                };
            }
        }
        log("æœŸè²¨è³‡æ–™è™•ç†å®Œæˆ");
    }

    var merged = [];
    for (var i = 0; i < txData.length; i++) {
        var tx = txData[i];
        var otcClose = otcMap[tx.date];
        var tsmcClose = tsmcMap[tx.date];
        
        if (isNaN(otcClose) || isNaN(tsmcClose)) continue;
        
        var item = {
            date: tx.date,
            close: tx.close,
            foreign: tx.foreign,
            trust: tx.trust,
            margin: tx.margin,
            marginChg: tx.marginChg,
            otcClose: otcClose,
            otcMargin: otcMarginMap[tx.date] || NaN,
            tsmcClose: tsmcClose,
            vix: 20,
            foreignOI: 0,
            instOI: 0
        };
        
        if (futureMap[tx.date]) {
            item.vix = futureMap[tx.date].vix || 20;
            item.foreignOI = futureMap[tx.date].foreignOI || 0;
            item.instOI = futureMap[tx.date].instOI || 0;
        }
        
        merged.push(item);
    }
    
    log("åˆä½µè³‡æ–™: " + merged.length + " ç­†");
    merged = merged.slice(-150);
    log("å–æœ€è¿‘150ç­†: " + merged.length + " ç­†");

    var txMa5 = calcMA(merged, "close", 5);
    var txMa10 = calcMA(merged, "close", 10);
    var txMa20 = calcMA(merged, "close", 20);
    var txMa60 = calcMA(merged, "close", 60);
    var otcMa10 = calcMA(merged, "otcClose", 10);
    var otcMa20 = calcMA(merged, "otcClose", 20);
    var otcMa60 = calcMA(merged, "otcClose", 60);
    var tsmcMa10 = calcMA(merged, "tsmcClose", 10);
    var tsmcMa20 = calcMA(merged, "tsmcClose", 20);
    var tsmcMa60 = calcMA(merged, "tsmcClose", 60);
    var txRsi = calcRSI(merged, "close", 14);
    log("å‡ç·šè¨ˆç®—å®Œæˆ");

    processed = [];
    for (var i = 0; i < merged.length; i++) {
        var row = merged[i];
        var txRet = i > 0 ? (row.close / merged[i-1].close - 1) * 100 : 0;
        var otcRet = i > 0 ? (row.otcClose / merged[i-1].otcClose - 1) * 100 : 0;
        var tsmcRet = i > 0 ? (row.tsmcClose / merged[i-1].tsmcClose - 1) * 100 : 0;
        var txBias20 = txMa20[i] ? (row.close / txMa20[i] - 1) * 100 : 0;

        var txDownDays = 0;
        for (var j = i; j > 0 && merged[j].close < merged[j-1].close; j--) txDownDays++;
        
        var foreignSellDays = 0;
        for (var j = i; j >= 0 && merged[j].foreign < 0; j--) foreignSellDays++;
        
        var marginUpDays = 0;
        for (var j = i; j >= 0 && merged[j].marginChg > 0; j--) marginUpDays++;

        var margin10dChg = i >= 10 && merged[i-10].margin ? (row.margin / merged[i-10].margin - 1) * 100 : 0;
        var otcMargin10dChg = i >= 10 && merged[i-10].otcMargin ? (row.otcMargin / merged[i-10].otcMargin - 1) * 100 : 0;
        var tx10dRet = i >= 10 ? (row.close / merged[i-10].close - 1) * 100 : 0;
        var foreignOI5dChg = i >= 5 ? row.foreignOI - merged[i-5].foreignOI : 0;
        var gain60 = i >= 60 ? (row.close / merged[i-60].close - 1) * 100 : 0;
        
        var high52 = row.close;
        for (var j = 0; j < Math.min(240, i+1); j++) {
            if (merged[i-j].close > high52) high52 = merged[i-j].close;
        }
        var distHigh = (row.close / high52 - 1) * 100;
        
        var otc5Ret = i >= 5 ? (row.otcClose / merged[i-5].otcClose - 1) * 100 : 0;
        var tx5Ret = i >= 5 ? (row.close / merged[i-5].close - 1) * 100 : 0;

        processed.push({
            date: row.date,
            txClose: row.close,
            txRet: txRet,
            txBias20: txBias20,
            txRsi: txRsi[i],
            tx10dRet: tx10dRet,
            txMa5: txMa5[i],
            txMa10: txMa10[i],
            txMa20: txMa20[i],
            txMa60: txMa60[i],
            txDownDays: txDownDays,
            otcClose: row.otcClose,
            otcRet: otcRet,
            otcMa10: otcMa10[i],
            otcMa20: otcMa20[i],
            otcMa60: otcMa60[i],
            otcTxGap5: otc5Ret - tx5Ret,
            tsmcClose: row.tsmcClose,
            tsmcRet: tsmcRet,
            tsmcMa10: tsmcMa10[i],
            tsmcMa20: tsmcMa20[i],
            tsmcMa60: tsmcMa60[i],
            foreign: row.foreign,
            foreignSellDays: foreignSellDays,
            trust: row.trust,
            margin: row.margin,
            marginChg: row.marginChg,
            marginUpDays: marginUpDays,
            margin10dChg: margin10dChg,
            otcMargin10dChg: otcMargin10dChg,
            vix: row.vix,
            foreignOI: row.foreignOI,
            instOI: row.instOI,
            foreignOI5dChg: foreignOI5dChg,
            gain60: gain60,
            distHigh: distHigh
        });
    }
    
    log("è³‡æ–™è™•ç†å®Œæˆï¼Œé–‹å§‹æ¸²æŸ“...");
    renderDashboard();
}

function renderDashboard() {
    var d = processed[processed.length - 1];
    log("æœ€æ–°è³‡æ–™æ—¥æœŸ: " + d.date);
    document.getElementById("dataDate").textContent = d.date;

    var txBelow5 = d.txClose < d.txMa5;
    var txBelow10 = d.txClose < d.txMa10;
    var txBelow20 = d.txClose < d.txMa20;
    var txBelow60 = d.txClose < d.txMa60;
    var otcBelow10 = d.otcClose < d.otcMa10;
    var otcBelow20 = d.otcClose < d.otcMa20;
    var otcBelow60 = d.otcClose < d.otcMa60;
    var tsmcBelow20 = d.tsmcClose < d.tsmcMa20;
    var tsmcBelow60 = d.tsmcClose < d.tsmcMa60;
    var allBelow10 = txBelow10 && otcBelow10 && d.tsmcClose < d.tsmcMa10;
    var allBelow60 = txBelow60 && tsmcBelow60;

    var marginPhase = 1;
    if (d.txRet > 0 && d.marginChg > 0) marginPhase = 1;
    else if (d.txRet < 0 && d.marginChg > 0) marginPhase = 2;
    else if (d.txRet < 0 && d.marginChg < 0) marginPhase = 3;
    else if (d.txRet > 0 && d.marginChg < 0) marginPhase = 4;

    var bestShortSignal = d.tx10dRet < -3 && d.margin10dChg > 2;

    var indicators = {
        overheat: [
            { name: "RSI > 70", value: d.txRsi.toFixed(1), check: d.txRsi > 70, weight: 1 },
            { name: "ä¹–é›¢ç‡ > 3%", value: d.txBias20.toFixed(2)+"%", check: d.txBias20 > 3, weight: 1 },
            { name: "ä¹–é›¢ç‡ > 5%", value: d.txBias20.toFixed(2)+"%", check: d.txBias20 > 5, weight: 1 },
            { name: "60æ—¥æ¼² > 15%", value: d.gain60.toFixed(1)+"%", check: d.gain60 > 15, weight: 1 },
            { name: "æ¥è¿‘52é€±é«˜", value: d.distHigh.toFixed(1)+"%", check: d.distHigh > -3, weight: 1 }
        ],
        margin: [
            { name: "èè³‡10æ—¥å¢>3%", value: d.margin10dChg.toFixed(2)+"%", check: d.margin10dChg > 3, weight: 1 },
            { name: "èè³‡10æ—¥å¢>5%", value: d.margin10dChg.toFixed(2)+"%", check: d.margin10dChg > 5, weight: 2 },
            { name: "èè³‡é€£å¢>=10å¤©", value: d.marginUpDays+"å¤©", check: d.marginUpDays >= 10, weight: 2 },
            { name: "æŒ‡æ•¸è·Œ+èè³‡å¢", value: d.tx10dRet.toFixed(1)+"%", check: bestShortSignal, weight: 4 },
            { name: "OTCèè³‡æ›´ç†±", value: (d.otcMargin10dChg-d.margin10dChg).toFixed(1)+"%", check: d.otcMargin10dChg > d.margin10dChg + 2, weight: 1 },
            { name: "éšæ®µ2(è·Œ+èå¢)", value: "éšæ®µ"+marginPhase, check: marginPhase === 2, weight: 2 }
        ],
        future: [
            { name: "å¤–è³‡æœŸè²¨5æ—¥æ¸›>5K", value: (d.foreignOI5dChg/1000).toFixed(1)+"K", check: d.foreignOI5dChg < -5000, weight: 1 },
            { name: "å¤–è³‡æœŸè²¨5æ—¥æ¸›>10K", value: (d.foreignOI5dChg/1000).toFixed(1)+"K", check: d.foreignOI5dChg < -10000, weight: 2 },
            { name: "å¤–è³‡æœŸè²¨5æ—¥æ¸›>15K", value: (d.foreignOI5dChg/1000).toFixed(1)+"K", check: d.foreignOI5dChg < -15000, weight: 3 },
            { name: "ä¸‰å¤§æ³•äººæ·¨ç©º>5K", value: (d.instOI/1000).toFixed(1)+"K", check: d.instOI < -5000, weight: 1 },
            { name: "ä¸‰å¤§æ³•äººæ·¨ç©º>10K", value: (d.instOI/1000).toFixed(1)+"K", check: d.instOI < -10000, weight: 2 },
            { name: "å¤–è³‡æœŸè²¨æ·¨ç©º>3è¬", value: (d.foreignOI/1000).toFixed(1)+"K", check: d.foreignOI < -30000, weight: 1 },
            { name: "VIX > 25 (åå‘)", value: d.vix.toFixed(2), check: d.vix > 25, weight: -1 }
        ],
        ma10: [
            { name: "å¤§ç›¤ç ´10å‡", value: txBelow10 ? "æ˜¯" : "å¦", check: txBelow10, weight: 1 },
            { name: "ç ´10å‡åœ¨20å‡ä¸Š", value: txBelow10 && !txBelow20 ? "æ˜¯" : "å¦", check: txBelow10 && !txBelow20, weight: 2 },
            { name: "OTCç ´10å‡(å¤§ç›¤æ²’ç ´)", value: otcBelow10 && !txBelow10 ? "æ˜¯" : "å¦", check: otcBelow10 && !txBelow10, weight: 2 },
            { name: "ä¸‰æŒ‡æ•¸åŒæ­¥ç ´10å‡", value: allBelow10 ? "æ˜¯" : "å¦", check: allBelow10, weight: 1 }
        ],
        price: [
            { name: "æ”¶é»‘K", value: d.txRet.toFixed(2)+"%", check: d.txRet < 0, weight: 1 },
            { name: "å¤§é»‘K (>1%)", value: d.txRet.toFixed(2)+"%", check: d.txRet < -1, weight: 2 },
            { name: "è·Œç ´20æ—¥å‡", value: txBelow20 ? "æ˜¯" : "å¦", check: txBelow20, weight: 2 },
            { name: "è·Œç ´60æ—¥å‡", value: txBelow60 ? "æ˜¯" : "å¦", check: txBelow60, weight: 3 },
            { name: "é€£è·Œ>=2å¤©", value: d.txDownDays+"å¤©", check: d.txDownDays >= 2, weight: 1 }
        ],
        chip: [
            { name: "å¤–è³‡è³£è¶…", value: (d.foreign/1e8).toFixed(1)+"å„„", check: d.foreign < 0, weight: 2 },
            { name: "å¤–è³‡é€£è³£>=3å¤©", value: d.foreignSellDays+"å¤©", check: d.foreignSellDays >= 3, weight: 3 },
            { name: "å¤–è³‡é€£è³£>=5å¤©", value: d.foreignSellDays+"å¤©", check: d.foreignSellDays >= 5, weight: 4 },
            { name: "æŠ•ä¿¡è³£è¶…", value: (d.trust/1e8).toFixed(1)+"å„„", check: d.trust < 0, weight: 1 }
        ],
        tsmc: [
            { name: "å°ç©æ”¶é»‘", value: d.tsmcRet.toFixed(2)+"%", check: d.tsmcRet < 0, weight: 1 },
            { name: "å°ç©è·Œ>1%", value: d.tsmcRet.toFixed(2)+"%", check: d.tsmcRet < -1, weight: 2 },
            { name: "å°ç©ç ´20å‡", value: tsmcBelow20 ? "æ˜¯" : "å¦", check: tsmcBelow20, weight: 2 },
            { name: "å°ç©+å¤§ç›¤åŒç ´60å‡", value: allBelow60 ? "æ˜¯" : "å¦", check: allBelow60, weight: 3 }
        ],
        otc: [
            { name: "OTCç ´20å‡(å¤§ç›¤æ²’ç ´)", value: otcBelow20 && !txBelow20 ? "æ˜¯" : "å¦", check: otcBelow20 && !txBelow20, weight: 2 },
            { name: "OTCé»‘/å¤§ç›¤ç´…", value: d.otcRet < 0 && d.txRet > 0 ? "æ˜¯" : "å¦", check: d.otcRet < 0 && d.txRet > 0, weight: 2 },
            { name: "OTC 5æ—¥å¼±>2%", value: d.otcTxGap5.toFixed(2)+"%", check: d.otcTxGap5 < -2, weight: 2 }
        ]
    };

    function sumScore(arr) {
        var s = 0;
        for (var i = 0; i < arr.length; i++) {
            if (arr[i].check) s += arr[i].weight;
        }
        return s;
    }

    var overheatScore = sumScore(indicators.overheat);
    var marginScore = sumScore(indicators.margin);
    var futureScore = hasFutureData ? sumScore(indicators.future) : 0;
    var ma10Score = sumScore(indicators.ma10);
    var priceScore = sumScore(indicators.price);
    var chipScore = sumScore(indicators.chip);
    var tsmcScore = sumScore(indicators.tsmc);
    var otcScore = sumScore(indicators.otc);
    var shortScore = marginScore + futureScore + ma10Score + priceScore + chipScore + tsmcScore + otcScore;

    var totalTriggered = 0;
    var allKeys = ["overheat", "margin", "future", "ma10", "price", "chip", "tsmc", "otc"];
    for (var k = 0; k < allKeys.length; k++) {
        var arr = indicators[allKeys[k]];
        for (var i = 0; i < arr.length; i++) {
            if (arr[i].check) totalTriggered++;
        }
    }

    var winRate = 45;
    if (bestShortSignal) winRate = 60.7;
    else if (shortScore >= 20) winRate = 52;
    else if (shortScore >= 15) winRate = 49;
    else if (shortScore >= 10) winRate = 47;

    var rec = { action: "ç­‰å¾…æ™‚æ©Ÿ", detail: "ç„¡æ˜é¡¯åšç©ºè¨Šè™Ÿ", cls: "rec-wait", level: "wait" };
    if (bestShortSignal) {
        rec = { action: "æœ€å¼·åšç©ºè¨Šè™Ÿ", detail: "æŒ‡æ•¸è·Œ+èè³‡å¢èƒŒé›¢ï¼æ­·å²10æ—¥è·Œç‡60.7%<br><b>ç©æ¥µåšç©ºï¼Œéƒ¨ä½50%</b>", cls: "rec-heavy", level: "heavy" };
    } else if (allBelow60 && shortScore >= 14) {
        rec = { action: "å¼·åŠ›åšç©º", detail: "å¤§ç›¤+å°ç©å‡ç ´60å‡ï¼Œç©ºæ–¹"+shortScore+"åˆ†<br><b>éƒ¨ä½80%</b>", cls: "rec-heavy", level: "heavy" };
    } else if (txBelow60 && shortScore >= 10) {
        rec = { action: "åŠ ç¢¼åšç©º", detail: "å¤§ç›¤ç ´60å‡ï¼Œç©ºæ–¹"+shortScore+"åˆ†<br><b>éƒ¨ä½50%</b>", cls: "rec-add", level: "add" };
    } else if (txBelow20 && shortScore >= 8) {
        rec = { action: "å»ºå€‰åšç©º", detail: "å¤§ç›¤ç ´20å‡ï¼Œç©ºæ–¹"+shortScore+"åˆ†<br><b>éƒ¨ä½30%</b>", cls: "rec-build", level: "build" };
    } else if (txBelow10 && shortScore >= 5) {
        rec = { action: "è©¦å–®åšç©º", detail: "å¤§ç›¤ç ´10å‡ï¼Œç©ºæ–¹"+shortScore+"åˆ†<br><b>éƒ¨ä½15%</b>", cls: "rec-trial", level: "trial" };
    } else if ((overheatScore >= 3 || marginScore >= 4 || futureScore >= 3) && shortScore >= 3) {
        rec = { action: "æº–å‚™åšç©º", detail: "éç†±"+overheatScore+"ï¼Œèè³‡"+marginScore+"ï¼ŒæœŸè²¨"+futureScore+"<br><b>ç­‰å¾…ç ´å‡ç·š</b>", cls: "rec-prepare", level: "prepare" };
    } else if (overheatScore >= 2 || marginPhase === 2 || futureScore >= 2) {
        rec = { action: "å¯†åˆ‡è§€å¯Ÿ", detail: "æœ‰è½‰å¼±è·¡è±¡ï¼ŒæŒçºŒè§€å¯Ÿ", cls: "rec-watch", level: "watch" };
    }

    function renderInd(list) {
        var html = "";
        for (var i = 0; i < list.length; i++) {
            var ind = list[i];
            var cls = ind.check ? "indicator-item triggered" : "indicator-item";
            var wt = ind.check ? ((ind.weight > 0 ? "+" : "") + ind.weight) : "";
            var st = ind.check ? "ğŸ”´" : "âšª";
            html += "<div class=\""+cls+"\"><span class=\"ind-name\">"+ind.name+"</span><span class=\"ind-value\">"+ind.value+"</span><span class=\"ind-weight\">"+wt+"</span><span class=\"ind-status\">"+st+"</span></div>";
        }
        return html;
    }

    function renderMA(close, ma5, ma10, ma20, ma60) {
        var items = [];
        if (ma5) items.push({v:ma5,l:"5æ—¥",a:close>ma5});
        if (ma10) items.push({v:ma10,l:"10æ—¥",a:close>ma10});
        if (ma20) items.push({v:ma20,l:"20æ—¥",a:close>ma20});
        if (ma60) items.push({v:ma60,l:"60æ—¥",a:close>ma60});
        var html = "<div class=\"ma-grid\">";
        for (var i = 0; i < items.length; i++) {
            var m = items[i];
            var cls = m.a ? "ma-item above" : "ma-item below";
            html += "<div class=\""+cls+"\"><div class=\"value\">"+m.v.toFixed(0)+"</div><div class=\"label\">"+m.l+"</div></div>";
        }
        html += "</div>";
        return html;
    }

    var html = "<div class=\"recommendation-box "+rec.cls+"\"><div class=\"rec-title\">ä»Šæ—¥æ“ä½œå»ºè­°</div><div class=\"rec-action\">"+rec.action+"</div><div class=\"rec-detail\">"+rec.detail+"</div></div>";

    if (!hasFutureData) {
        html += "<div class=\"status-box\">æœŸè²¨è³‡æ–™æœªè¼‰å…¥ï¼Œè«‹ç¢ºèª future_index.xlsx å·²ä¸Šå‚³åˆ°GitHub</div>";
    }

    if (bestShortSignal) {
        html += "<div class=\"alert-box alert-red\"><h4 style=\"color:#ff4444;\">æœ€å¼·åšç©ºè¨Šè™Ÿè§¸ç™¼ï¼</h4><p>æŒ‡æ•¸10æ—¥è·Œ"+d.tx10dRet.toFixed(1)+"% + èè³‡10æ—¥å¢"+d.margin10dChg.toFixed(1)+"% - æ­·å²10æ—¥è·Œç‡60.7%</p></div>";
    }
    if (txBelow10 && !txBelow20) {
        html += "<div class=\"alert-box alert-orange\"><h4 style=\"color:#ff9800;\">é«˜æª”è½‰å¼±</h4><p>ç ´10å‡ä½†é‚„åœ¨20å‡ä¸Šï¼Œ84%æ©Ÿç‡10å¤©å…§ç ´20å‡</p></div>";
    }
    if (marginPhase === 2) {
        html += "<div class=\"alert-box alert-yellow\"><h4 style=\"color:#ffc107;\">èè³‡éšæ®µ2</h4><p>æŒ‡æ•¸è·Œ+èè³‡å¢ï¼Œæ•£æˆ¶ä¸èªè¼¸</p></div>";
    }
    if (hasFutureData && d.foreignOI5dChg < -10000) {
        html += "<div class=\"alert-box alert-yellow\"><h4 style=\"color:#ffc107;\">å¤–è³‡æœŸè²¨æ¸›ç¢¼</h4><p>5æ—¥æ¸›ç¢¼"+(Math.abs(d.foreignOI5dChg)/1000).toFixed(1)+"Kå£ï¼Œæ­·å²10æ—¥è·Œç‡48%</p></div>";
    }

    function scoreColor(score, t1, t2) {
        if (score >= t2) return "#ff0000";
        if (score >= t1) return "#ff6b6b";
        return "#48dbfb";
    }

    html += "<div class=\"score-display\">";
    html += "<div class=\"score-item\"><div class=\"score-value\" style=\"color:"+(overheatScore>=3?"#ff6b6b":"#feca57")+"\">"+overheatScore+"</div><div class=\"score-label\">éç†±</div></div>";
    html += "<div class=\"score-item\"><div class=\"score-value\" style=\"color:"+scoreColor(marginScore,3,5)+"\">"+marginScore+"</div><div class=\"score-label\">èè³‡</div></div>";
    html += "<div class=\"score-item\"><div class=\"score-value\" style=\"color:"+scoreColor(futureScore,2,4)+"\">"+futureScore+"</div><div class=\"score-label\">æœŸè²¨</div></div>";
    html += "<div class=\"score-item\"><div class=\"score-value\" style=\"color:"+scoreColor(shortScore,10,15)+"\">"+shortScore+"</div><div class=\"score-label\">ç©ºæ–¹ç¸½åˆ†</div></div>";
    html += "<div class=\"score-item\"><div class=\"score-value\">"+totalTriggered+"</div><div class=\"score-label\">è§¸ç™¼æ•¸</div></div>";
    html += "<div class=\"score-item\"><div class=\"score-value\" style=\"color:"+(winRate>=55?"#ff0000":winRate>=48?"#ff6b6b":"#feca57")+"\">"+winRate.toFixed(1)+"%</div><div class=\"score-label\">æ­·å²è·Œç‡</div></div>";
    html += "</div>";

    if (hasFutureData) {
        var foreignView = d.foreignOI > 10000 ? "bullish" : d.foreignOI < -10000 ? "bearish" : "";
        var instView = d.instOI > 5000 ? "bullish" : d.instOI < -5000 ? "bearish" : "";
        html += "<div class=\"card\"><div class=\"card-title\">æœŸè²¨ç±Œç¢¼</div><div class=\"future-stats\">";
        html += "<div class=\"future-stat\"><div class=\"stat-value\">"+d.vix.toFixed(2)+"</div><div class=\"stat-label\">VIXææ…Œ</div></div>";
        html += "<div class=\"future-stat "+foreignView+"\"><div class=\"stat-value\">"+(d.foreignOI/1000).toFixed(1)+"K</div><div class=\"stat-label\">å¤–è³‡æ·¨å£</div></div>";
        html += "<div class=\"future-stat "+instView+"\"><div class=\"stat-value\">"+(d.instOI/1000).toFixed(1)+"K</div><div class=\"stat-label\">æ³•äººæ·¨å£</div></div>";
        html += "<div class=\"future-stat "+(d.foreignOI5dChg<-5000?"bearish":"")+"\"><div class=\"stat-value\">"+(d.foreignOI5dChg/1000).toFixed(1)+"K</div><div class=\"stat-label\">å¤–è³‡5æ—¥è®ŠåŒ–</div></div>";
        html += "</div></div>";
    }

    html += "<div class=\"card\"><div class=\"card-title\">èè³‡å¾ªç’°</div>";
    html += "<div class=\"phase-box\">";
    html += "<div class=\"phase-item "+(marginPhase===1?"active":"")+"\"><div class=\"phase-name\">éšæ®µ1</div><div class=\"phase-label\">æœ€ä½³</div><div class=\"phase-hint\">æ¼²+èå¢</div></div>";
    html += "<div class=\"phase-item "+(marginPhase===2?"active":"")+"\"><div class=\"phase-name\">éšæ®µ2</div><div class=\"phase-label\" style=\"color:#ff6b6b;\">èµ·è·Œ</div><div class=\"phase-hint\">è·Œ+èå¢</div></div>";
    html += "<div class=\"phase-item "+(marginPhase===3?"active":"")+"\"><div class=\"phase-name\">éšæ®µ3</div><div class=\"phase-label\">æœ€æ®º</div><div class=\"phase-hint\">è·Œ+èæ¸›</div></div>";
    html += "<div class=\"phase-item "+(marginPhase===4?"active":"")+"\"><div class=\"phase-name\">éšæ®µ4</div><div class=\"phase-label\">åå½ˆ</div><div class=\"phase-hint\">æ¼²+èæ¸›</div></div>";
    html += "</div>";
    html += "<div class=\"margin-stats\">";
    html += "<div class=\"margin-stat\"><div class=\"stat-value\">"+(d.margin/1e8).toFixed(0)+"å„„</div><div class=\"stat-label\">åŠ æ¬Šèè³‡</div></div>";
    html += "<div class=\"margin-stat\"><div class=\"stat-value\" style=\"color:"+(d.margin10dChg>3?"#ff6b6b":"#26de81")+"\">"+(d.margin10dChg>0?"+":"")+d.margin10dChg.toFixed(1)+"%</div><div class=\"stat-label\">10æ—¥è®ŠåŒ–</div></div>";
    html += "</div></div>";

    html += "<div class=\"grid-3 grid\">";
    html += "<div class=\"card\"><div class=\"card-title\">åŠ æ¬ŠæŒ‡æ•¸</div><div class=\"price-box\"><div class=\"price-main\">"+d.txClose.toLocaleString()+"</div><div class=\"price-change "+(d.txRet>=0?"up":"down")+"\">"+(d.txRet>=0?"â–²":"â–¼")+Math.abs(d.txRet).toFixed(2)+"%</div></div>"+renderMA(d.txClose, d.txMa5, d.txMa10, d.txMa20, d.txMa60)+"</div>";
    html += "<div class=\"card\"><div class=\"card-title\">OTCæ«ƒè²·</div><div class=\"price-box\"><div class=\"price-main\">"+d.otcClose.toFixed(2)+"</div><div class=\"price-change "+(d.otcRet>=0?"up":"down")+"\">"+(d.otcRet>=0?"â–²":"â–¼")+Math.abs(d.otcRet).toFixed(2)+"%</div></div>"+renderMA(d.otcClose, null, d.otcMa10, d.otcMa20, d.otcMa60)+"</div>";
    html += "<div class=\"card\"><div class=\"card-title\">å°ç©é›»</div><div class=\"price-box\"><div class=\"price-main\">"+d.tsmcClose.toLocaleString()+"</div><div class=\"price-change "+(d.tsmcRet>=0?"up":"down")+"\">"+(d.tsmcRet>=0?"â–²":"â–¼")+Math.abs(d.tsmcRet).toFixed(2)+"%</div></div>"+renderMA(d.tsmcClose, null, d.tsmcMa10, d.tsmcMa20, d.tsmcMa60)+"</div>";
    html += "</div>";

    html += "<div class=\"grid-2 grid\">";
    html += "<div class=\"card\"><div class=\"card-title\">èè³‡è¨Šè™Ÿ<span class=\"card-score\">"+marginScore+"</span></div>"+renderInd(indicators.margin)+"</div>";
    html += "<div class=\"card\"><div class=\"card-title\">æœŸè²¨ç±Œç¢¼<span class=\"card-score\">"+futureScore+"</span></div>"+renderInd(indicators.future)+"</div>";
    html += "</div>";

    html += "<div class=\"grid-2 grid\">";
    html += "<div class=\"card\"><div class=\"card-title\">éç†±æŒ‡æ¨™<span class=\"card-score\">"+overheatScore+"</span></div>"+renderInd(indicators.overheat)+"</div>";
    html += "<div class=\"card\"><div class=\"card-title\">10å‡é è­¦<span class=\"card-score\">"+ma10Score+"</span></div>"+renderInd(indicators.ma10)+"</div>";
    html += "</div>";

    html += "<div class=\"grid-2 grid\">";
    html += "<div class=\"card\"><div class=\"card-title\">åƒ¹æ ¼è¨Šè™Ÿ<span class=\"card-score\">"+priceScore+"</span></div>"+renderInd(indicators.price)+"</div>";
    html += "<div class=\"card\"><div class=\"card-title\">ç¾è²¨ç±Œç¢¼<span class=\"card-score\">"+chipScore+"</span></div>"+renderInd(indicators.chip)+"</div>";
    html += "</div>";

    html += "<div class=\"grid-2 grid\">";
    html += "<div class=\"card\"><div class=\"card-title\">å°ç©é›»<span class=\"card-score\">"+tsmcScore+"</span></div>"+renderInd(indicators.tsmc)+"</div>";
    html += "<div class=\"card\"><div class=\"card-title\">OTCé ˜å…ˆ<span class=\"card-score\">"+otcScore+"</span></div>"+renderInd(indicators.otc)+"</div>";
    html += "</div>";

    html += "<div class=\"card\"><div class=\"card-title\">é‡‘å­—å¡”ç­–ç•¥</div><table class=\"action-table\"><tr><th>éšæ®µ</th><th>æ¢ä»¶</th><th>éƒ¨ä½</th><th>ç‹€æ…‹</th></tr>";
    html += "<tr class=\"action-row "+(rec.level==="watch"||rec.level==="wait"?"current":"")+"\"><td>è§€å¯Ÿ</td><td>éç†±/èè³‡/æœŸè²¨è¨Šè™Ÿ</td><td>0%</td><td>"+(overheatScore>=2||marginScore>=2||futureScore>=2?"âœ“":"-")+"</td></tr>";
    html += "<tr class=\"action-row "+(rec.level==="prepare"?"current":"")+"\"><td>æº–å‚™</td><td>è¨Šè™Ÿç´¯ç©>=3</td><td>0%</td><td>"+(overheatScore>=3||marginScore>=4||futureScore>=3?"âœ“":"-")+"</td></tr>";
    html += "<tr class=\"action-row "+(rec.level==="trial"?"current":"")+"\"><td>è©¦å–®</td><td>ç ´10å‡+ç©ºæ–¹>=5</td><td>15%</td><td>"+(txBelow10&&shortScore>=5?"âœ“":"-")+"</td></tr>";
    html += "<tr class=\"action-row "+(rec.level==="build"?"current":"")+"\"><td>å»ºå€‰</td><td>ç ´20å‡+ç©ºæ–¹>=8</td><td>30%</td><td>"+(txBelow20&&shortScore>=8?"âœ“":"-")+"</td></tr>";
    html += "<tr class=\"action-row "+(rec.level==="add"?"current":"")+"\"><td>åŠ ç¢¼</td><td>ç ´60å‡+ç©ºæ–¹>=10</td><td>50%</td><td>"+(txBelow60&&shortScore>=10?"âœ“":"-")+"</td></tr>";
    html += "<tr class=\"action-row "+(rec.level==="heavy"?"current":"")+"\"><td>é‡å£“</td><td>æœ€å¼·è¨Šè™Ÿ/é›™ç ´60å‡</td><td>80%</td><td>"+(bestShortSignal||allBelow60?"âœ“":"-")+"</td></tr>";
    html += "</table></div>";

    html += "<div class=\"card\"><div class=\"card-title\">è¿‘30æ—¥èµ°å‹¢</div><div class=\"chart-container\"><canvas id=\"priceChart\"></canvas></div></div>";

    document.getElementById("mainContent").innerHTML = html;
    log("ä»‹é¢æ¸²æŸ“å®Œæˆ");

    if (typeof Chart !== "undefined") {
        try {
            var ctx = document.getElementById("priceChart").getContext("2d");
            var last30 = processed.slice(-30);
            var labels = [];
            var txData = [];
            var otcData = [];
            var ma20Data = [];
            for (var i = 0; i < last30.length; i++) {
                labels.push(last30[i].date.slice(5));
                txData.push(last30[i].txClose);
                otcData.push(last30[i].otcClose);
                ma20Data.push(last30[i].txMa20);
            }
            new Chart(ctx, {
                type: "line",
                data: {
                    labels: labels,
                    datasets: [
                        { label: "åŠ æ¬Š", data: txData, borderColor: "#48dbfb", fill: false, tension: 0.3, yAxisID: "y", pointRadius: 1 },
                        { label: "OTC", data: otcData, borderColor: "#feca57", fill: false, tension: 0.3, yAxisID: "y1", pointRadius: 1 },
                        { label: "20å‡", data: ma20Data, borderColor: "#ff6b6b", borderDash: [4,4], fill: false, pointRadius: 0, yAxisID: "y" }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: "index", intersect: false },
                    plugins: { legend: { labels: { color: "#888", font: { size: 8 } } } },
                    scales: {
                        x: { ticks: { color: "#666", font: { size: 7 } }, grid: { color: "rgba(255,255,255,0.05)" } },
                        y: { type: "linear", position: "left", ticks: { color: "#48dbfb", font: { size: 7 } }, grid: { color: "rgba(255,255,255,0.05)" } },
                        y1: { type: "linear", position: "right", ticks: { color: "#feca57", font: { size: 7 } }, grid: { drawOnChartArea: false } }
                    }
                }
            });
            log("åœ–è¡¨ç¹ªè£½å®Œæˆ");
        } catch (e) {
            log("åœ–è¡¨ç¹ªè£½å¤±æ•—: " + e.message);
        }
    }
    
    log("=== è¼‰å…¥å®Œæˆ ===");
}
```

})();
</script>

</body>
</html>