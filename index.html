<!DOCTYPE html>

<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°è‚¡åšç©ºè¨Šè™Ÿç³»çµ± Pro v4</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Microsoft JhengHei', sans-serif; background: linear-gradient(135deg, #0f0f23 0%, #1a1a3e 100%); color: #eee; min-height: 100vh; padding: 12px; }
        .container { max-width: 1600px; margin: 0 auto; }
        header { text-align: center; padding: 15px; background: rgba(255,255,255,0.03); border-radius: 12px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.1); }
        header h1 { font-size: 1.6em; background: linear-gradient(90deg, #ff416c, #ff4b2b, #f7971e); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .subtitle { color: #888; margin-top: 6px; font-size: 0.85em; }
        .recommendation-box { background: linear-gradient(135deg, rgba(255,65,108,0.15), rgba(255,75,43,0.15)); border: 2px solid; border-radius: 15px; padding: 20px; margin-bottom: 15px; text-align: center; }
        .rec-title { font-size: 1.1em; margin-bottom: 10px; }
        .rec-action { font-size: 2em; font-weight: bold; margin: 10px 0; }
        .rec-detail { font-size: 0.95em; color: #ccc; line-height: 1.7; }
        .rec-wait { border-color: #666; } .rec-watch { border-color: #feca57; } .rec-prepare { border-color: #ff9f43; }
        .rec-trial { border-color: #ff6b6b; } .rec-build { border-color: #ee5a24; } .rec-add { border-color: #eb2f06; }
        .rec-heavy { border-color: #ff0000; animation: glow 1.5s infinite; }
        @keyframes glow { 0%, 100% { box-shadow: 0 0 15px rgba(255,0,0,0.3); } 50% { box-shadow: 0 0 30px rgba(255,0,0,0.6); } }
        .score-display { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin: 15px 0; }
        .score-item { text-align: center; padding: 10px 12px; background: rgba(255,255,255,0.05); border-radius: 10px; min-width: 75px; }
        .score-value { font-size: 1.6em; font-weight: bold; }
        .score-label { color: #888; margin-top: 3px; font-size: 0.7em; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 10px; margin-bottom: 10px; }
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); }
        .grid-3 { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
        .card { background: rgba(255,255,255,0.03); border-radius: 10px; padding: 12px; border: 1px solid rgba(255,255,255,0.08); }
        .card-title { font-size: 0.85em; color: #48dbfb; margin-bottom: 8px; padding-bottom: 5px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; }
        .card-score { background: rgba(255,107,107,0.2); padding: 2px 7px; border-radius: 8px; font-size: 0.8em; }
        .indicator-item { display: flex; justify-content: space-between; align-items: center; padding: 4px 5px; margin: 2px 0; background: rgba(255,255,255,0.02); border-radius: 4px; border-left: 3px solid transparent; font-size: 0.75em; }
        .indicator-item.triggered { background: rgba(255,107,107,0.15); border-left-color: #ff6b6b; }
        .ind-name { flex: 1; } .ind-value { min-width: 65px; text-align: right; font-family: monospace; font-size: 0.8em; color: #aaa; }
        .ind-weight { min-width: 28px; text-align: center; font-size: 0.65em; color: #ff6b6b; } .ind-status { min-width: 14px; text-align: center; }
        .price-box { text-align: center; padding: 5px; }
        .price-main { font-size: 1.4em; font-weight: bold; }
        .price-change { font-size: 0.8em; margin-top: 2px; }
        .up { color: #ff6b6b; } .down { color: #26de81; }
        .ma-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 2px; margin-top: 5px; }
        .ma-item { text-align: center; padding: 3px 2px; background: rgba(255,255,255,0.03); border-radius: 3px; }
        .ma-item .value { font-size: 0.75em; font-weight: bold; } .ma-item .label { font-size: 0.5em; color: #888; }
        .ma-item.above { border-bottom: 2px solid #26de81; } .ma-item.below { border-bottom: 2px solid #ff6b6b; }
        .alert-box { border-radius: 8px; padding: 10px; margin: 8px 0; text-align: center; }
        .alert-red { background: linear-gradient(135deg, rgba(255,0,0,0.2), rgba(200,0,0,0.2)); border: 1px solid #ff4444; }
        .alert-yellow { background: linear-gradient(135deg, rgba(255,193,7,0.2), rgba(255,152,0,0.2)); border: 1px solid #ffc107; }
        .alert-orange { background: linear-gradient(135deg, rgba(255,152,0,0.2), rgba(255,87,34,0.2)); border: 1px solid #ff9800; }
        .alert-box h4 { margin-bottom: 4px; font-size: 0.9em; }
        .alert-box p { font-size: 0.8em; color: #ccc; }
        .phase-box { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin: 8px 0; }
        .phase-item { text-align: center; padding: 8px 4px; background: rgba(255,255,255,0.03); border-radius: 6px; border: 2px solid transparent; }
        .phase-item.active { border-color: #feca57; background: rgba(254,202,87,0.1); }
        .phase-item .phase-name { font-size: 0.7em; color: #888; }
        .phase-item .phase-label { font-size: 0.85em; font-weight: bold; margin: 2px 0; }
        .phase-item .phase-hint { font-size: 0.6em; color: #666; }
        .margin-stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; margin-top: 6px; }
        .margin-stat { text-align: center; padding: 6px; background: rgba(255,255,255,0.02); border-radius: 5px; }
        .margin-stat .stat-value { font-size: 1em; font-weight: bold; }
        .margin-stat .stat-label { font-size: 0.65em; color: #888; }
        .future-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-top: 6px; }
        .future-stat { text-align: center; padding: 8px 4px; background: rgba(255,255,255,0.02); border-radius: 5px; }
        .future-stat .stat-value { font-size: 1.1em; font-weight: bold; }
        .future-stat .stat-label { font-size: 0.6em; color: #888; }
        .future-stat.bullish .stat-value { color: #ff6b6b; }
        .future-stat.bearish .stat-value { color: #26de81; }
        .action-table { width: 100%; margin-top: 6px; font-size: 0.7em; }
        .action-table th, .action-table td { padding: 5px 2px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.08); }
        .action-table th { color: #888; font-weight: normal; } .action-row.current { background: rgba(255,107,107,0.2); }
        .chart-container { height: 160px; margin-top: 6px; }
        .loading { text-align: center; padding: 50px 15px; }
        .spinner { width: 35px; height: 35px; border: 3px solid #333; border-top-color: #ff6b6b; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 12px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .error-box { background: rgba(255,107,107,0.2); border: 1px solid #ff6b6b; padding: 15px; border-radius: 8px; text-align: center; }
        .status-box { background: rgba(255,193,7,0.1); border: 1px solid #ffc107; padding: 10px; border-radius: 8px; margin: 10px 0; font-size: 0.8em; }
        footer { text-align: center; padding: 10px; color: #555; font-size: 0.65em; margin-top: 12px; }
        @media (max-width: 768px) { 
            .grid, .grid-2, .grid-3 { grid-template-columns: 1fr; } 
            .score-display { gap: 5px; } 
            .score-item { min-width: 55px; padding: 7px 5px; } 
            .score-value { font-size: 1.3em; } 
            .rec-action { font-size: 1.2em; } 
            .phase-box { grid-template-columns: repeat(2, 1fr); }
            .future-stats { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>ğŸ¯ å°è‚¡åšç©ºè¨Šè™Ÿç³»çµ± Pro v4</h1>
        <p class="subtitle">å‡ç·šç³»çµ± + èè³‡å¾ªç’° + æœŸè²¨ç±Œç¢¼ + OTCé ˜å…ˆ + å°ç©é›»</p>
        <p class="subtitle">è³‡æ–™æ—¥æœŸï¼š<span id="dataDate">è¼‰å…¥ä¸­...</span></p>
    </header>
    <div id="mainContent"><div class="loading"><div class="spinner"></div><p>æ­£åœ¨è¼‰å…¥è³‡æ–™...</p><p id="loadStatus" style="margin-top:10px;font-size:0.8em;color:#888;"></p></div></div>
    <footer><p>âš ï¸ æœ¬ç³»çµ±åƒ…ä¾›è³‡æ–™æ•´ç†åƒè€ƒï¼Œä¸æ§‹æˆæŠ•è³‡å»ºè­°ã€‚åšç©ºé¢¨éšªæ¥µé«˜ï¼ŒæŠ•è³‡æ±ºç­–è«‹è‡ªè¡Œåˆ¤æ–·ã€‚</p></footer>
</div>
<script>
const CONFIG = {
    TXINDEX_URL: 'https://raw.githubusercontent.com/rexdashu168/twindex/main/TXINDEX.xlsx',
    OTC_URL: 'https://raw.githubusercontent.com/rexdashu168/twindex/main/OTCindex.xlsx',
    TSMC_URL: 'https://raw.githubusercontent.com/rexdashu168/twindex/main/2330.xlsx',
    FUTURE_URL: 'https://raw.githubusercontent.com/rexdashu168/twindex/main/future_index.xlsx',
};
let processed = [];
let hasFutureData = false;
window.onload = () => loadAllData();

async function loadAllData() {
const statusEl = document.getElementById(â€˜loadStatusâ€™);
try {
statusEl.textContent = â€˜è¼‰å…¥åŠ æ¬ŠæŒ‡æ•¸â€¦â€™;
const txData = await fetchXLSX(CONFIG.TXINDEX_URL);

```
    statusEl.textContent = 'è¼‰å…¥OTCæŒ‡æ•¸...';
    const otcData = await fetchXLSX(CONFIG.OTC_URL);
    
    statusEl.textContent = 'è¼‰å…¥å°ç©é›»...';
    const tsmcData = await fetchXLSX(CONFIG.TSMC_URL);
    
    let futureData = null;
    try {
        statusEl.textContent = 'è¼‰å…¥æœŸè²¨è³‡æ–™...';
        futureData = await fetchXLSX(CONFIG.FUTURE_URL);
        hasFutureData = true;
    } catch (e) {
        console.log('æœŸè²¨è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨åŸºæœ¬æ¨¡å¼', e);
        hasFutureData = false;
    }
    
    processData(txData, otcData, tsmcData, futureData);
} catch (err) {
    document.getElementById('mainContent').innerHTML = '<div class="error-box"><h3>âŒ è¼‰å…¥å¤±æ•—</h3><p style="margin-top:8px;color:#aaa;">'+err.message+'</p><button onclick="loadAllData()" style="margin-top:12px;padding:8px 20px;background:#667eea;border:none;border-radius:5px;color:#fff;cursor:pointer;">é‡è©¦</button></div>';
}
```

}

async function fetchXLSX(url) {
const response = await fetch(url);
if (!response.ok) throw new Error(â€˜ç„¡æ³•è¼‰å…¥: â€™ + url.split(â€™/â€™).pop());
const buffer = await response.arrayBuffer();
const workbook = XLSX.read(buffer, { type: â€˜arrayâ€™ });
return XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { raw: false });
}

function parseNum(v) {
if (v === null || v === undefined || v === â€˜â€™ || v === â€˜NaNâ€™ || v === â€˜N/Aâ€™) return NaN;
let s = String(v).replace(/,/g, â€˜â€™);
if (s.includes(â€˜å„„â€™)) return parseFloat(s.replace(â€˜å„„â€™, â€˜â€™)) * 1e8;
if (s.includes(â€˜è¬â€™)) return parseFloat(s.replace(â€˜è¬â€™, â€˜â€™)) * 1e4;
return parseFloat(s);
}

function parseDate(v) {
if (!v) return null;
if (typeof v === â€˜numberâ€™) return new Date((v - 25569) * 86400 * 1000).toISOString().split(â€˜Tâ€™)[0].replace(/-/g, â€˜/â€™);
return String(v).split(â€™ â€™)[0];
}

function calcMA(data, field, period) {
return data.map((_, i) => {
if (i < period - 1) return NaN;
let sum = 0; for (let j = 0; j < period; j++) sum += data[i - j][field];
return sum / period;
});
}

function calcRSI(data, field, period) {
let result = [], gains = [], losses = [];
for (let i = 0; i < data.length; i++) {
if (i === 0) { result.push(50); continue; }
let change = data[i][field] - data[i-1][field];
gains.push(change > 0 ? change : 0); losses.push(change < 0 ? -change : 0);
if (i < period) result.push(50);
else {
let avgG = gains.slice(-period).reduce((a,b)=>a+b,0) / period;
let avgL = losses.slice(-period).reduce((a,b)=>a+b,0) / period;
result.push(avgL === 0 ? 100 : 100 - (100 / (1 + avgG/avgL)));
}
}
return result;
}

function processData(txRaw, otcRaw, tsmcRaw, futureRaw) {
let txData = txRaw.map(row => ({
date: parseDate(row[â€˜æ™‚é–“â€™]),
close: parseNum(row[â€˜æ”¶ç›¤åƒ¹â€™]),
foreign: parseNum(row[â€˜è²·è³£è¶…(å…ƒ)â€™]),
trust: parseNum(row[â€˜è²·è³£è¶…(å…ƒ).1â€™]),
margin: parseNum(row[â€˜èè³‡(å…ƒ)â€™]),
marginChg: parseNum(row[â€˜å·®é¡(å…ƒ)â€™])
})).filter(d => !isNaN(d.close) && d.date);

```
let otcMap = {}, otcMarginMap = {}, tsmcMap = {}, futureMap = {};
otcRaw.forEach(row => { 
    let date = parseDate(row['æ™‚é–“']); 
    if (date) {
        otcMap[date] = parseNum(row['æ”¶ç›¤åƒ¹']);
        otcMarginMap[date] = parseNum(row['èè³‡(å…ƒ)']);
    }
});
tsmcRaw.forEach(row => { 
    let date = parseDate(row['æ™‚é–“']); 
    if (date) tsmcMap[date] = parseNum(row['æ”¶ç›¤åƒ¹']); 
});

if (futureRaw) {
    futureRaw.forEach(row => {
        let date = parseDate(row['æ™‚é–“']);
        if (date) {
            futureMap[date] = {
                vix: parseNum(row['VIX(ææ…ŒæŒ‡æ•¸)']),
                foreignOI: parseNum(row['å¤–è³‡åŠé™¸è³‡æœªå¹³å€‰æ·¨å£']),
                instOI: parseNum(row['ä¸‰å¤§æ³•äººæœªå¹³å€‰æ·¨å£']),
                top10OI: parseNum(row['å‰åå¤§äº¤æ˜“äººæ·¨å£']),
                oi: parseNum(row['æœªå¹³å€‰'])
            };
        }
    });
}

let merged = txData.map(tx => {
    let base = { 
        ...tx, 
        otcClose: otcMap[tx.date] || NaN, 
        otcMargin: otcMarginMap[tx.date] || NaN,
        tsmcClose: tsmcMap[tx.date] || NaN,
        vix: 20, foreignOI: 0, instOI: 0
    };
    if (futureMap[tx.date]) {
        base.vix = futureMap[tx.date].vix || 20;
        base.foreignOI = futureMap[tx.date].foreignOI || 0;
        base.instOI = futureMap[tx.date].instOI || 0;
    }
    return base;
}).filter(d => !isNaN(d.otcClose) && !isNaN(d.tsmcClose));

merged = merged.slice(-150);

let txMa5 = calcMA(merged, 'close', 5), txMa10 = calcMA(merged, 'close', 10), txMa20 = calcMA(merged, 'close', 20), txMa60 = calcMA(merged, 'close', 60);
let otcMa10 = calcMA(merged, 'otcClose', 10), otcMa20 = calcMA(merged, 'otcClose', 20), otcMa60 = calcMA(merged, 'otcClose', 60);
let tsmcMa10 = calcMA(merged, 'tsmcClose', 10), tsmcMa20 = calcMA(merged, 'tsmcClose', 20), tsmcMa60 = calcMA(merged, 'tsmcClose', 60);
let txRsi = calcRSI(merged, 'close', 14);

processed = merged.map((row, i) => {
    let txRet = i > 0 ? (row.close / merged[i-1].close - 1) * 100 : 0;
    let otcRet = i > 0 ? (row.otcClose / merged[i-1].otcClose - 1) * 100 : 0;
    let tsmcRet = i > 0 ? (row.tsmcClose / merged[i-1].tsmcClose - 1) * 100 : 0;
    let txBias20 = txMa20[i] ? (row.close / txMa20[i] - 1) * 100 : 0;
    
    let txDownDays = 0, foreignSellDays = 0, marginUpDays = 0;
    for (let j = i; j > 0 && merged[j].close < merged[j-1].close; j--) txDownDays++;
    for (let j = i; j >= 0 && merged[j].foreign < 0; j--) foreignSellDays++;
    for (let j = i; j >= 0 && merged[j].marginChg > 0; j--) marginUpDays++;
    
    let margin10dChg = i >= 10 && merged[i-10].margin ? (row.margin / merged[i-10].margin - 1) * 100 : 0;
    let otcMargin10dChg = i >= 10 && merged[i-10].otcMargin ? (row.otcMargin / merged[i-10].otcMargin - 1) * 100 : 0;
    let tx10dRet = i >= 10 ? (row.close / merged[i-10].close - 1) * 100 : 0;
    let foreignOI5dChg = i >= 5 ? row.foreignOI - merged[i-5].foreignOI : 0;
    
    let gain60 = i >= 60 ? (row.close / merged[i-60].close - 1) * 100 : 0;
    let high52 = row.close; for (let j = 0; j < Math.min(240, i+1); j++) if (merged[i-j].close > high52) high52 = merged[i-j].close;
    let distHigh = (row.close / high52 - 1) * 100;
    let otc5Ret = i >= 5 ? (row.otcClose / merged[i-5].otcClose - 1) * 100 : 0;
    let tx5Ret = i >= 5 ? (row.close / merged[i-5].close - 1) * 100 : 0;
    
    return {
        date: row.date,
        txClose: row.close, txRet, txBias20, txRsi: txRsi[i], tx10dRet,
        txMa5: txMa5[i], txMa10: txMa10[i], txMa20: txMa20[i], txMa60: txMa60[i], txDownDays,
        otcClose: row.otcClose, otcRet, otcMa10: otcMa10[i], otcMa20: otcMa20[i], otcMa60: otcMa60[i],
        otcTxGap5: otc5Ret - tx5Ret,
        tsmcClose: row.tsmcClose, tsmcRet, tsmcMa10: tsmcMa10[i], tsmcMa20: tsmcMa20[i], tsmcMa60: tsmcMa60[i],
        foreign: row.foreign, foreignSellDays, trust: row.trust,
        margin: row.margin, marginChg: row.marginChg, marginUpDays, margin10dChg, otcMargin10dChg,
        vix: row.vix, foreignOI: row.foreignOI, instOI: row.instOI, foreignOI5dChg,
        gain60, distHigh
    };
});
renderDashboard();
```

}

function renderDashboard() {
const d = processed[processed.length - 1];
document.getElementById(â€˜dataDateâ€™).textContent = d.date;

```
const txBelow5 = d.txClose < d.txMa5, txBelow10 = d.txClose < d.txMa10, txBelow20 = d.txClose < d.txMa20, txBelow60 = d.txClose < d.txMa60;
const otcBelow10 = d.otcClose < d.otcMa10, otcBelow20 = d.otcClose < d.otcMa20, otcBelow60 = d.otcClose < d.otcMa60;
const tsmcBelow20 = d.tsmcClose < d.tsmcMa20, tsmcBelow60 = d.tsmcClose < d.tsmcMa60;
const allBelow10 = txBelow10 && otcBelow10 && d.tsmcClose < d.tsmcMa10;
const allBelow60 = txBelow60 && tsmcBelow60;

let marginPhase = 1;
if (d.txRet > 0 && d.marginChg > 0) marginPhase = 1;
else if (d.txRet < 0 && d.marginChg > 0) marginPhase = 2;
else if (d.txRet < 0 && d.marginChg < 0) marginPhase = 3;
else if (d.txRet > 0 && d.marginChg < 0) marginPhase = 4;

const bestShortSignal = d.tx10dRet < -3 && d.margin10dChg > 2;

const indicators = {
    overheat: [
        { name: 'RSI > 70', value: d.txRsi.toFixed(1), check: d.txRsi > 70, weight: 1 },
        { name: 'ä¹–é›¢ç‡ > 3%', value: d.txBias20.toFixed(2)+'%', check: d.txBias20 > 3, weight: 1 },
        { name: 'ä¹–é›¢ç‡ > 5%', value: d.txBias20.toFixed(2)+'%', check: d.txBias20 > 5, weight: 1 },
        { name: '60æ—¥æ¼² > 15%', value: d.gain60.toFixed(1)+'%', check: d.gain60 > 15, weight: 1 },
        { name: 'æ¥è¿‘52é€±é«˜', value: d.distHigh.toFixed(1)+'%', check: d.distHigh > -3, weight: 1 },
    ],
    margin: [
        { name: 'èè³‡10æ—¥å¢>3%', value: d.margin10dChg.toFixed(2)+'%', check: d.margin10dChg > 3, weight: 1 },
        { name: 'èè³‡10æ—¥å¢>5%', value: d.margin10dChg.toFixed(2)+'%', check: d.margin10dChg > 5, weight: 2 },
        { name: 'èè³‡é€£å¢â‰¥10å¤©', value: d.marginUpDays+'å¤©', check: d.marginUpDays >= 10, weight: 2 },
        { name: 'â­æŒ‡æ•¸è·Œ+èè³‡å¢', value: d.tx10dRet.toFixed(1)+'%', check: bestShortSignal, weight: 4 },
        { name: 'OTCèè³‡æ›´ç†±', value: (d.otcMargin10dChg-d.margin10dChg).toFixed(1)+'%', check: d.otcMargin10dChg > d.margin10dChg + 2, weight: 1 },
        { name: 'éšæ®µ2(è·Œ+èå¢)', value: 'éšæ®µ'+marginPhase, check: marginPhase === 2, weight: 2 },
    ],
    future: [
        { name: 'å¤–è³‡æœŸè²¨5æ—¥æ¸›>5K', value: (d.foreignOI5dChg/1000).toFixed(1)+'K', check: d.foreignOI5dChg < -5000, weight: 1 },
        { name: 'å¤–è³‡æœŸè²¨5æ—¥æ¸›>10K', value: (d.foreignOI5dChg/1000).toFixed(1)+'K', check: d.foreignOI5dChg < -10000, weight: 2 },
        { name: 'å¤–è³‡æœŸè²¨5æ—¥æ¸›>15K', value: (d.foreignOI5dChg/1000).toFixed(1)+'K', check: d.foreignOI5dChg < -15000, weight: 3 },
        { name: 'ä¸‰å¤§æ³•äººæ·¨ç©º>5K', value: (d.instOI/1000).toFixed(1)+'K', check: d.instOI < -5000, weight: 1 },
        { name: 'ä¸‰å¤§æ³•äººæ·¨ç©º>10K', value: (d.instOI/1000).toFixed(1)+'K', check: d.instOI < -10000, weight: 2 },
        { name: 'å¤–è³‡æœŸè²¨æ·¨ç©º>3è¬', value: (d.foreignOI/1000).toFixed(1)+'K', check: d.foreignOI < -30000, weight: 1 },
        { name: 'VIX > 25 (åå‘)', value: d.vix.toFixed(2), check: d.vix > 25, weight: -1 },
    ],
    ma10: [
        { name: 'å¤§ç›¤ç ´10å‡', value: txBelow10 ? 'æ˜¯' : 'å¦', check: txBelow10, weight: 1 },
        { name: 'ç ´10å‡åœ¨20å‡ä¸Š', value: txBelow10 && !txBelow20 ? 'æ˜¯' : 'å¦', check: txBelow10 && !txBelow20, weight: 2 },
        { name: 'OTCç ´10å‡(å¤§ç›¤æ²’ç ´)', value: otcBelow10 && !txBelow10 ? 'æ˜¯' : 'å¦', check: otcBelow10 && !txBelow10, weight: 2 },
        { name: 'ä¸‰æŒ‡æ•¸åŒæ­¥ç ´10å‡', value: allBelow10 ? 'æ˜¯' : 'å¦', check: allBelow10, weight: 1 },
    ],
    price: [
        { name: 'æ”¶é»‘K', value: d.txRet.toFixed(2)+'%', check: d.txRet < 0, weight: 1 },
        { name: 'å¤§é»‘K (>1%)', value: d.txRet.toFixed(2)+'%', check: d.txRet < -1, weight: 2 },
        { name: 'è·Œç ´20æ—¥å‡', value: txBelow20 ? 'æ˜¯' : 'å¦', check: txBelow20, weight: 2 },
        { name: 'è·Œç ´60æ—¥å‡', value: txBelow60 ? 'æ˜¯' : 'å¦', check: txBelow60, weight: 3 },
        { name: 'é€£è·Œâ‰¥2å¤©', value: d.txDownDays+'å¤©', check: d.txDownDays >= 2, weight: 1 },
    ],
    chip: [
        { name: 'å¤–è³‡è³£è¶…', value: (d.foreign/1e8).toFixed(1)+'å„„', check: d.foreign < 0, weight: 2 },
        { name: 'å¤–è³‡é€£è³£â‰¥3å¤©', value: d.foreignSellDays+'å¤©', check: d.foreignSellDays >= 3, weight: 3 },
        { name: 'å¤–è³‡é€£è³£â‰¥5å¤©', value: d.foreignSellDays+'å¤©', check: d.foreignSellDays >= 5, weight: 4 },
        { name: 'æŠ•ä¿¡è³£è¶…', value: (d.trust/1e8).toFixed(1)+'å„„', check: d.trust < 0, weight: 1 },
    ],
    tsmc: [
        { name: 'å°ç©æ”¶é»‘', value: d.tsmcRet.toFixed(2)+'%', check: d.tsmcRet < 0, weight: 1 },
        { name: 'å°ç©è·Œ>1%', value: d.tsmcRet.toFixed(2)+'%', check: d.tsmcRet < -1, weight: 2 },
        { name: 'å°ç©ç ´20å‡', value: tsmcBelow20 ? 'æ˜¯' : 'å¦', check: tsmcBelow20, weight: 2 },
        { name: 'å°ç©+å¤§ç›¤åŒç ´60å‡', value: allBelow60 ? 'æ˜¯' : 'å¦', check: allBelow60, weight: 3 },
    ],
    otc: [
        { name: 'OTCç ´20å‡(å¤§ç›¤æ²’ç ´)', value: otcBelow20 && !txBelow20 ? 'æ˜¯' : 'å¦', check: otcBelow20 && !txBelow20, weight: 2 },
        { name: 'OTCé»‘/å¤§ç›¤ç´…', value: d.otcRet < 0 && d.txRet > 0 ? 'æ˜¯' : 'å¦', check: d.otcRet < 0 && d.txRet > 0, weight: 2 },
        { name: 'OTC 5æ—¥å¼±>2%', value: d.otcTxGap5.toFixed(2)+'%', check: d.otcTxGap5 < -2, weight: 2 },
    ],
};

let overheatScore = indicators.overheat.filter(i => i.check).reduce((s,i) => s + i.weight, 0);
let marginScore = indicators.margin.filter(i => i.check).reduce((s,i) => s + i.weight, 0);
let futureScore = hasFutureData ? indicators.future.filter(i => i.check).reduce((s,i) => s + i.weight, 0) : 0;
let ma10Score = indicators.ma10.filter(i => i.check).reduce((s,i) => s + i.weight, 0);
let priceScore = indicators.price.filter(i => i.check).reduce((s,i) => s + i.weight, 0);
let chipScore = indicators.chip.filter(i => i.check).reduce((s,i) => s + i.weight, 0);
let tsmcScore = indicators.tsmc.filter(i => i.check).reduce((s,i) => s + i.weight, 0);
let otcScore = indicators.otc.filter(i => i.check).reduce((s,i) => s + i.weight, 0);
let shortScore = marginScore + futureScore + ma10Score + priceScore + chipScore + tsmcScore + otcScore;
let totalTriggered = Object.values(indicators).flat().filter(i => i.check).length;

function getWinRate(score, hasSignal) { 
    if (hasSignal) return 60.7;
    if (score >= 20) return 52; 
    if (score >= 15) return 49; 
    if (score >= 10) return 47; 
    return 45; 
}
let winRate = getWinRate(shortScore, bestShortSignal);

function getRecommendation() {
    if (bestShortSignal) return { action: 'ğŸš¨ æœ€å¼·åšç©ºè¨Šè™Ÿ', detail: 'æŒ‡æ•¸è·Œ+èè³‡å¢èƒŒé›¢ï¼æ­·å²10æ—¥è·Œç‡60.7%<br><b>ç©æ¥µåšç©ºï¼Œéƒ¨ä½50%</b>', class: 'rec-heavy', level: 'heavy' };
    if (allBelow60 && shortScore >= 14) return { action: 'ğŸ”¥ å¼·åŠ›åšç©º', detail: 'å¤§ç›¤+å°ç©å‡ç ´60å‡ï¼Œç©ºæ–¹'+shortScore+'åˆ†<br><b>éƒ¨ä½80%</b>', class: 'rec-heavy', level: 'heavy' };
    if (txBelow60 && shortScore >= 10) return { action: 'ğŸ“‰ åŠ ç¢¼åšç©º', detail: 'å¤§ç›¤ç ´60å‡ï¼Œç©ºæ–¹'+shortScore+'åˆ†<br><b>éƒ¨ä½50%</b>', class: 'rec-add', level: 'add' };
    if (txBelow20 && shortScore >= 8) return { action: 'ğŸ“Š å»ºå€‰åšç©º', detail: 'å¤§ç›¤ç ´20å‡ï¼Œç©ºæ–¹'+shortScore+'åˆ†<br><b>éƒ¨ä½30%</b>', class: 'rec-build', level: 'build' };
    if (txBelow10 && shortScore >= 5) return { action: 'ğŸ¯ è©¦å–®åšç©º', detail: 'å¤§ç›¤ç ´10å‡ï¼Œç©ºæ–¹'+shortScore+'åˆ†<br><b>éƒ¨ä½15%</b>', class: 'rec-trial', level: 'trial' };
    if ((overheatScore >= 3 || marginScore >= 4 || futureScore >= 3) && shortScore >= 3) return { action: 'âš¡ æº–å‚™åšç©º', detail: 'éç†±'+overheatScore+'ï¼Œèè³‡'+marginScore+'ï¼ŒæœŸè²¨'+futureScore+'<br><b>ç­‰å¾…ç ´å‡ç·š</b>', class: 'rec-prepare', level: 'prepare' };
    if (overheatScore >= 2 || marginPhase === 2 || futureScore >= 2) return { action: 'ğŸ‘€ å¯†åˆ‡è§€å¯Ÿ', detail: 'æœ‰è½‰å¼±è·¡è±¡ï¼ŒæŒçºŒè§€å¯Ÿ', class: 'rec-watch', level: 'watch' };
    return { action: 'â³ ç­‰å¾…æ™‚æ©Ÿ', detail: 'ç„¡æ˜é¡¯åšç©ºè¨Šè™Ÿ', class: 'rec-wait', level: 'wait' };
}
let rec = getRecommendation();

function renderInd(list) {
    return list.map(ind => '<div class="indicator-item '+(ind.check?'triggered':'')+'"><span class="ind-name">'+ind.name+'</span><span class="ind-value">'+ind.value+'</span><span class="ind-weight">'+(ind.check?(ind.weight>0?'+':'')+ind.weight:'')+'</span><span class="ind-status">'+(ind.check?'ğŸ”´':'âšª')+'</span></div>').join('');
}

function renderMA(close, ma5, ma10, ma20, ma60) {
    let items = [];
    if (ma5) items.push({v:ma5,l:'5æ—¥',a:close>ma5});
    if (ma10) items.push({v:ma10,l:'10æ—¥',a:close>ma10});
    if (ma20) items.push({v:ma20,l:'20æ—¥',a:close>ma20});
    if (ma60) items.push({v:ma60,l:'60æ—¥',a:close>ma60});
    return '<div class="ma-grid">'+items.map(m=>'<div class="ma-item '+(m.a?'above':'below')+'"><div class="value">'+m.v.toFixed(0)+'</div><div class="label">'+m.l+'</div></div>').join('')+'</div>';
}

let html = '<div class="recommendation-box '+rec.class+'"><div class="rec-title">ğŸ“Œ ä»Šæ—¥æ“ä½œå»ºè­°</div><div class="rec-action">'+rec.action+'</div><div class="rec-detail">'+rec.detail+'</div></div>';

if (!hasFutureData) html += '<div class="status-box">âš ï¸ æœŸè²¨è³‡æ–™æœªè¼‰å…¥ï¼Œè«‹ç¢ºèª future_index.xlsx å·²ä¸Šå‚³åˆ°GitHub</div>';

if (bestShortSignal) html += '<div class="alert-box alert-red"><h4 style="color:#ff4444;">ğŸš¨ æœ€å¼·åšç©ºè¨Šè™Ÿè§¸ç™¼ï¼</h4><p>æŒ‡æ•¸10æ—¥è·Œ'+d.tx10dRet.toFixed(1)+'% + èè³‡10æ—¥å¢'+d.margin10dChg.toFixed(1)+'% â†’ æ­·å²10æ—¥è·Œç‡60.7%</p></div>';
if (txBelow10 && !txBelow20) html += '<div class="alert-box alert-orange"><h4 style="color:#ff9800;">âš ï¸ é«˜æª”è½‰å¼±</h4><p>ç ´10å‡ä½†é‚„åœ¨20å‡ä¸Šï¼Œ84%æ©Ÿç‡10å¤©å…§ç ´20å‡</p></div>';
if (marginPhase === 2) html += '<div class="alert-box alert-yellow"><h4 style="color:#ffc107;">âš ï¸ èè³‡éšæ®µ2</h4><p>æŒ‡æ•¸è·Œ+èè³‡å¢ï¼Œæ•£æˆ¶ä¸èªè¼¸</p></div>';
if (hasFutureData && d.foreignOI5dChg < -10000) html += '<div class="alert-box alert-yellow"><h4 style="color:#ffc107;">âš ï¸ å¤–è³‡æœŸè²¨æ¸›ç¢¼</h4><p>5æ—¥æ¸›ç¢¼'+(Math.abs(d.foreignOI5dChg)/1000).toFixed(1)+'Kå£ï¼Œæ­·å²10æ—¥è·Œç‡48%</p></div>';

html += '<div class="score-display">'+
    '<div class="score-item"><div class="score-value" style="color:'+(overheatScore>=3?'#ff6b6b':'#feca57')+'">'+overheatScore+'</div><div class="score-label">éç†±</div></div>'+
    '<div class="score-item"><div class="score-value" style="color:'+(marginScore>=5?'#ff0000':marginScore>=3?'#ff6b6b':'#48dbfb')+'">'+marginScore+'</div><div class="score-label">èè³‡</div></div>'+
    '<div class="score-item"><div class="score-value" style="color:'+(futureScore>=4?'#ff6b6b':futureScore>=2?'#feca57':'#48dbfb')+'">'+futureScore+'</div><div class="score-label">æœŸè²¨</div></div>'+
    '<div class="score-item"><div class="score-value" style="color:'+(shortScore>=15?'#ff0000':shortScore>=10?'#ff6b6b':'#48dbfb')+'">'+shortScore+'</div><div class="score-label">ç©ºæ–¹ç¸½åˆ†</div></div>'+
    '<div class="score-item"><div class="score-value">'+totalTriggered+'</div><div class="score-label">è§¸ç™¼æ•¸</div></div>'+
    '<div class="score-item"><div class="score-value" style="color:'+(winRate>=55?'#ff0000':winRate>=48?'#ff6b6b':'#feca57')+'">'+winRate.toFixed(1)+'%</div><div class="score-label">æ­·å²è·Œç‡</div></div></div>';

// æœŸè²¨ç±Œç¢¼
if (hasFutureData) {
    let foreignView = d.foreignOI > 10000 ? 'bullish' : d.foreignOI < -10000 ? 'bearish' : '';
    let instView = d.instOI > 5000 ? 'bullish' : d.instOI < -5000 ? 'bearish' : '';
    html += '<div class="card"><div class="card-title">ğŸ“Š æœŸè²¨ç±Œç¢¼</div>'+
        '<div class="future-stats">'+
        '<div class="future-stat"><div class="stat-value">'+d.vix.toFixed(2)+'</div><div class="stat-label">VIXææ…Œ</div></div>'+
        '<div class="future-stat '+foreignView+'"><div class="stat-value">'+(d.foreignOI/1000).toFixed(1)+'K</div><div class="stat-label">å¤–è³‡æ·¨å£</div></div>'+
        '<div class="future-stat '+instView+'"><div class="stat-value">'+(d.instOI/1000).toFixed(1)+'K</div><div class="stat-label">æ³•äººæ·¨å£</div></div>'+
        '<div class="future-stat '+(d.foreignOI5dChg<-5000?'bearish':'')+'"><div class="stat-value">'+(d.foreignOI5dChg/1000).toFixed(1)+'K</div><div class="stat-label">å¤–è³‡5æ—¥è®ŠåŒ–</div></div>'+
        '</div></div>';
}

// èè³‡å››éšæ®µ
html += '<div class="card"><div class="card-title">ğŸ’° èè³‡å¾ªç’°</div>'+
    '<div class="phase-box">'+
    '<div class="phase-item '+(marginPhase===1?'active':'')+'"><div class="phase-name">éšæ®µ1</div><div class="phase-label">æœ€ä½³</div><div class="phase-hint">æ¼²+èå¢</div></div>'+
    '<div class="phase-item '+(marginPhase===2?'active':'')+'"><div class="phase-name">éšæ®µ2</div><div class="phase-label" style="color:#ff6b6b;">èµ·è·Œâš ï¸</div><div class="phase-hint">è·Œ+èå¢</div></div>'+
    '<div class="phase-item '+(marginPhase===3?'active':'')+'"><div class="phase-name">éšæ®µ3</div><div class="phase-label">æœ€æ®º</div><div class="phase-hint">è·Œ+èæ¸›</div></div>'+
    '<div class="phase-item '+(marginPhase===4?'active':'')+'"><div class="phase-name">éšæ®µ4</div><div class="phase-label">åå½ˆ</div><div class="phase-hint">æ¼²+èæ¸›</div></div></div>'+
    '<div class="margin-stats">'+
    '<div class="margin-stat"><div class="stat-value">'+(d.margin/1e8).toFixed(0)+'å„„</div><div class="stat-label">åŠ æ¬Šèè³‡</div></div>'+
    '<div class="margin-stat"><div class="stat-value" style="color:'+(d.margin10dChg>3?'#ff6b6b':'#26de81')+'">'+(d.margin10dChg>0?'+':'')+d.margin10dChg.toFixed(1)+'%</div><div class="stat-label">10æ—¥è®ŠåŒ–</div></div></div></div>';

// ä¸‰æŒ‡æ•¸
html += '<div class="grid-3 grid">'+
    '<div class="card"><div class="card-title">åŠ æ¬ŠæŒ‡æ•¸</div><div class="price-box"><div class="price-main">'+d.txClose.toLocaleString()+'</div><div class="price-change '+(d.txRet>=0?'up':'down')+'">'+(d.txRet>=0?'â–²':'â–¼')+Math.abs(d.txRet).toFixed(2)+'%</div></div>'+renderMA(d.txClose, d.txMa5, d.txMa10, d.txMa20, d.txMa60)+'</div>'+
    '<div class="card"><div class="card-title">OTCæ«ƒè²·</div><div class="price-box"><div class="price-main">'+d.otcClose.toFixed(2)+'</div><div class="price-change '+(d.otcRet>=0?'up':'down')+'">'+(d.otcRet>=0?'â–²':'â–¼')+Math.abs(d.otcRet).toFixed(2)+'%</div></div>'+renderMA(d.otcClose, null, d.otcMa10, d.otcMa20, d.otcMa60)+'</div>'+
    '<div class="card"><div class="card-title">å°ç©é›»</div><div class="price-box"><div class="price-main">'+d.tsmcClose.toLocaleString()+'</div><div class="price-change '+(d.tsmcRet>=0?'up':'down')+'">'+(d.tsmcRet>=0?'â–²':'â–¼')+Math.abs(d.tsmcRet).toFixed(2)+'%</div></div>'+renderMA(d.tsmcClose, null, d.tsmcMa10, d.tsmcMa20, d.tsmcMa60)+'</div></div>';

// æŒ‡æ¨™å¡ç‰‡
html += '<div class="grid-2 grid">'+
    '<div class="card"><div class="card-title">ğŸ’° èè³‡è¨Šè™Ÿ<span class="card-score">'+marginScore+'</span></div>'+renderInd(indicators.margin)+'</div>'+
    '<div class="card"><div class="card-title">ğŸ“ˆ æœŸè²¨ç±Œç¢¼<span class="card-score">'+futureScore+'</span></div>'+renderInd(indicators.future)+'</div></div>';

html += '<div class="grid-2 grid">'+
    '<div class="card"><div class="card-title">ğŸŒ¡ï¸ éç†±æŒ‡æ¨™<span class="card-score">'+overheatScore+'</span></div>'+renderInd(indicators.overheat)+'</div>'+
    '<div class="card"><div class="card-title">ğŸ“ 10å‡é è­¦<span class="card-score">'+ma10Score+'</span></div>'+renderInd(indicators.ma10)+'</div></div>';

html += '<div class="grid-2 grid">'+
    '<div class="card"><div class="card-title">ğŸ“‰ åƒ¹æ ¼è¨Šè™Ÿ<span class="card-score">'+priceScore+'</span></div>'+renderInd(indicators.price)+'</div>'+
    '<div class="card"><div class="card-title">ğŸ’¼ ç¾è²¨ç±Œç¢¼<span class="card-score">'+chipScore+'</span></div>'+renderInd(indicators.chip)+'</div></div>';

html += '<div class="grid-2 grid">'+
    '<div class="card"><div class="card-title">ğŸ­ å°ç©é›»<span class="card-score">'+tsmcScore+'</span></div>'+renderInd(indicators.tsmc)+'</div>'+
    '<div class="card"><div class="card-title">ğŸ”® OTCé ˜å…ˆ<span class="card-score">'+otcScore+'</span></div>'+renderInd(indicators.otc)+'</div></div>';

// ç­–ç•¥è¡¨
html += '<div class="card"><div class="card-title">ğŸ“‹ é‡‘å­—å¡”ç­–ç•¥</div><table class="action-table"><tr><th>éšæ®µ</th><th>æ¢ä»¶</th><th>éƒ¨ä½</th><th>ç‹€æ…‹</th></tr>'+
    '<tr class="action-row '+(rec.level==='watch'||rec.level==='wait'?'current':'')+'"><td>è§€å¯Ÿ</td><td>éç†±/èè³‡/æœŸè²¨è¨Šè™Ÿ</td><td>0%</td><td>'+(overheatScore>=2||marginScore>=2||futureScore>=2?'âœ“':'-')+'</td></tr>'+
    '<tr class="action-row '+(rec.level==='prepare'?'current':'')+'"><td>æº–å‚™</td><td>è¨Šè™Ÿç´¯ç©â‰¥3</td><td>0%</td><td>'+(overheatScore>=3||marginScore>=4||futureScore>=3?'âœ“':'-')+'</td></tr>'+
    '<tr class="action-row '+(rec.level==='trial'?'current':'')+'"><td>è©¦å–®</td><td>ç ´10å‡+ç©ºæ–¹â‰¥5</td><td>15%</td><td>'+(txBelow10&&shortScore>=5?'âœ“':'-')+'</td></tr>'+
    '<tr class="action-row '+(rec.level==='build'?'current':'')+'"><td>å»ºå€‰</td><td>ç ´20å‡+ç©ºæ–¹â‰¥8</td><td>30%</td><td>'+(txBelow20&&shortScore>=8?'âœ“':'-')+'</td></tr>'+
    '<tr class="action-row '+(rec.level==='add'?'current':'')+'"><td>åŠ ç¢¼</td><td>ç ´60å‡+ç©ºæ–¹â‰¥10</td><td>50%</td><td>'+(txBelow60&&shortScore>=10?'âœ“':'-')+'</td></tr>'+
    '<tr class="action-row '+(rec.level==='heavy'?'current':'')+'"><td>é‡å£“</td><td>æœ€å¼·è¨Šè™Ÿ/é›™ç ´60å‡</td><td>80%</td><td>'+(bestShortSignal||allBelow60?'âœ“':'-')+'</td></tr></table></div>';

// åœ–è¡¨
html += '<div class="card"><div class="card-title">ğŸ“ˆ è¿‘30æ—¥èµ°å‹¢</div><div class="chart-container"><canvas id="priceChart"></canvas></div></div>';

document.getElementById('mainContent').innerHTML = html;

const ctx = document.getElementById('priceChart').getContext('2d');
const last30 = processed.slice(-30);
new Chart(ctx, {
    type: 'line',
    data: {
        labels: last30.map(d => d.date.slice(5)),
        datasets: [
            { label: 'åŠ æ¬Š', data: last30.map(d => d.txClose), borderColor: '#48dbfb', fill: false, tension: 0.3, yAxisID: 'y', pointRadius: 1 },
            { label: 'OTC', data: last30.map(d => d.otcClose), borderColor: '#feca57', fill: false, tension: 0.3, yAxisID: 'y1', pointRadius: 1 },
            { label: '20å‡', data: last30.map(d => d.txMa20), borderColor: '#ff6b6b', borderDash: [4,4], fill: false, pointRadius: 0, yAxisID: 'y' }
        ]
    },
    options: { 
        responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
        plugins: { legend: { labels: { color: '#888', font: { size: 8 } } } },
        scales: { 
            x: { ticks: { color: '#666', font: { size: 7 } }, grid: { color: 'rgba(255,255,255,0.05)' } },
            y: { type: 'linear', position: 'left', ticks: { color: '#48dbfb', font: { size: 7 } }, grid: { color: 'rgba(255,255,255,0.05)' } },
            y1: { type: 'linear', position: 'right', ticks: { color: '#feca57', font: { size: 7 } }, grid: { drawOnChartArea: false } }
        }
    }
});
```

}
</script>

</body>
</html>